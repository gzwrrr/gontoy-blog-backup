<!DOCTYPE html>
<html lang="en-US" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.60" />
    <meta name="theme" content="VuePress Theme Hope" />
    <link rel="icon" href="https://my-photos-1.oss-cn-hangzhou.aliyuncs.com/Individual/logo.png"><link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#21332d"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"><link rel="icon" href="/logo.png"><title>Netty ç®€å•ä½¿ç”¨</title><meta name="description" content="Netty ç®€å•ä½¿ç”¨">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-42911d78.css" as="style"><link rel="stylesheet" href="/assets/style-42911d78.css">
    <link rel="modulepreload" href="/assets/app-f746a503.js"><link rel="modulepreload" href="/assets/framework-ec2af7a3.js"><link rel="modulepreload" href="/assets/Netty.html-4b0b2ed1.js"><link rel="modulepreload" href="/assets/Netty.html-7cbbe0a7.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to main content</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><!----><!----><!----></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" aria-label="ä¸»é¡µ"><FontIcon icon="zhuye"></FontIcon>ä¸»é¡µ<!----></a></div><div class="nav-item hide-in-mobile"><a href="/guide/" class="nav-link" aria-label="å¯¼èˆª"><FontIcon icon="tubiaozhuanqu-16"></FontIcon>å¯¼èˆª<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="ç¼–ç¨‹è¯­è¨€"><span class="title"><FontIcon icon="code"></FontIcon>ç¼–ç¨‹è¯­è¨€</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/article/java/" class="nav-link" aria-label="Java"><FontIcon></FontIcon>Java<!----></a></li><li class="dropdown-item"><a href="/article/go/" class="nav-link" aria-label="Go"><FontIcon></FontIcon>Go<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a href="/article/algorithm/" class="nav-link" aria-label="ç®—æ³•"><FontIcon icon="jichengsuanfa"></FontIcon>ç®—æ³•<!----></a></div><div class="nav-item hide-in-mobile"><a href="/article/springs/" class="nav-link" aria-label="Springs"><FontIcon icon="bxl-spring-boot"></FontIcon>Springs<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="æ•°æ®åº“"><span class="title"><FontIcon icon="database-full"></FontIcon>æ•°æ®åº“</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/article/mysql/" class="nav-link" aria-label="MySQL"><FontIcon></FontIcon>MySQL<!----></a></li><li class="dropdown-item"><a href="/article/redis/" class="nav-link" aria-label="Redis"><FontIcon></FontIcon>Redis<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="è®¾è®¡"><span class="title"><FontIcon icon="sheji1"></FontIcon>è®¾è®¡</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/article/design/" class="nav-link" aria-label="è®¾è®¡æ¨¡å¼"><FontIcon></FontIcon>è®¾è®¡æ¨¡å¼<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="ä¸­é—´ä»¶"><span class="title"><FontIcon icon="zhongjianjian"></FontIcon>ä¸­é—´ä»¶</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/article/rabbitmq/" class="nav-link" aria-label="RabbitMQ"><FontIcon></FontIcon>RabbitMQ<!----></a></li><li class="dropdown-item"><a href="/article/elasticsearch/" class="nav-link" aria-label="ElasticSearch"><FontIcon></FontIcon>ElasticSearch<!----></a></li><li class="dropdown-item"><a href="/article/mongodb/" class="nav-link" aria-label="Mongodb"><FontIcon></FontIcon>Mongodb<!----></a></li><li class="dropdown-item"><a href="/article/netty/" class="nav-link active" aria-label="Netty"><FontIcon></FontIcon>Netty<!----></a></li><li class="dropdown-item"><a href="/article/quartz/" class="nav-link" aria-label="Quartz"><FontIcon></FontIcon>Quartz<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="è¿ç»´"><span class="title"><FontIcon icon="yunwei-yunweirizhi"></FontIcon>è¿ç»´</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/article/git/" class="nav-link" aria-label="Git"><FontIcon></FontIcon>Git<!----></a></li><li class="dropdown-item"><a href="/article/docker/" class="nav-link" aria-label="Docker"><FontIcon></FontIcon>Docker<!----></a></li><li class="dropdown-item"><a href="/article/jenkins/" class="nav-link" aria-label="Jenkins"><FontIcon></FontIcon>Jenkins<!----></a></li><li class="dropdown-item"><a href="/article/linux/" class="nav-link" aria-label="Linux"><FontIcon></FontIcon>Linux<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a href="/article/modeling/" class="nav-link" aria-label="æ•°å­¦å»ºæ¨¡"><FontIcon icon="qita"></FontIcon>æ•°å­¦å»ºæ¨¡<!----></a></div><div class="nav-item hide-in-mobile"><a href="/article/other/" class="nav-link" aria-label="å…¶ä»–æ–‡ç« "><FontIcon icon="qita"></FontIcon>å…¶ä»–æ–‡ç« <!----></a></div><div class="nav-item hide-in-mobile"><a href="/about/" class="nav-link" aria-label="å…³äº"><FontIcon icon="guanyu1"></FontIcon>å…³äº<!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><!----><!----><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><!--[--><button class="search-pro-button" role="search" aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg></button><!--]--><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><a href="/article/netty/" class="nav-link sidebar-link sidebar-page" aria-label="Netty"><FontIcon></FontIcon>Netty<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/article/netty/Netty.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="Netty ç®€å•ä½¿ç”¨"><FontIcon></FontIcon>Netty ç®€å•ä½¿ç”¨<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><div><!----><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><FontIcon icon></FontIcon>Netty ç®€å•ä½¿ç”¨</h1><div class="page-info"><span class="page-author-info" aria-label="AuthorğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">gzw</span></span><span property="author" content="gzw"></span></span><!----><span class="page-date-info" aria-label="Writing DateğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2022-10-04T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="Reading TimeâŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>About 33 min</span><meta property="timeRequired" content="PT33M"></span><span class="page-category-info" aria-label="CategoryğŸŒˆ" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><span class="page-category-item category6 clickable" role="navigation">netty</span><span class="page-category-item category2 clickable" role="navigation">é€šä¿¡</span><span class="page-category-item category5 clickable" role="navigation">ä¸­é—´ä»¶</span><meta property="articleSection" content="netty,é€šä¿¡,ä¸­é—´ä»¶"></span><span class="page-tag-info" aria-label="TagğŸ·" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><span class="page-tag-item tag6 clickable" role="navigation">netty</span><span class="page-tag-item tag2 clickable" role="navigation">é€šä¿¡</span><span class="page-tag-item tag5 clickable" role="navigation">ä¸­é—´ä»¶</span><meta property="keywords" content="netty,é€šä¿¡,ä¸­é—´ä»¶"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">On This Page<button class="print-button" title="print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#netty-ç®€å•ä½¿ç”¨" class="router-link-active router-link-exact-active toc-link level1">Netty ç®€å•ä½¿ç”¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#i-o-æ¨¡å‹" class="router-link-active router-link-exact-active toc-link level1">I/O æ¨¡å‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#nio" class="router-link-active router-link-exact-active toc-link level1">NIO</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#buffer" class="router-link-active router-link-exact-active toc-link level2">Buffer</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#åŸºæœ¬ä½¿ç”¨" class="router-link-active router-link-exact-active toc-link level3">åŸºæœ¬ä½¿ç”¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#mappedbytebuffer" class="router-link-active router-link-exact-active toc-link level3">MappedByteBuffer</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#channel" class="router-link-active router-link-exact-active toc-link level2">Channel</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#åŸºæœ¬ä½¿ç”¨-1" class="router-link-active router-link-exact-active toc-link level3">åŸºæœ¬ä½¿ç”¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#scatteringandgathering" class="router-link-active router-link-exact-active toc-link level3">ScatteringAndGathering</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#selector" class="router-link-active router-link-exact-active toc-link level2">Selector</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#åŸºæœ¬ä½¿ç”¨-2" class="router-link-active router-link-exact-active toc-link level3">åŸºæœ¬ä½¿ç”¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#èŠå¤©å®¤" class="router-link-active router-link-exact-active toc-link level3">èŠå¤©å®¤</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#é›¶æ‹·è´" class="router-link-active router-link-exact-active toc-link level2">é›¶æ‹·è´</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#netty-ç®€ä»‹" class="router-link-active router-link-exact-active toc-link level1">Netty ç®€ä»‹</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#reactor-æ¨¡å¼" class="router-link-active router-link-exact-active toc-link level2">Reactor æ¨¡å¼</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#å•çº¿ç¨‹æ¨¡å‹" class="router-link-active router-link-exact-active toc-link level3">å•çº¿ç¨‹æ¨¡å‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#å¤šçº¿ç¨‹æ¨¡å‹" class="router-link-active router-link-exact-active toc-link level3">å¤šçº¿ç¨‹æ¨¡å‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#ä¸»ä»-reactor-å¤šçº¿ç¨‹" class="router-link-active router-link-exact-active toc-link level3">ä¸»ä» Reactor å¤šçº¿ç¨‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#netty-ä¸»ä»å¤šçº¿ç¨‹" class="router-link-active router-link-exact-active toc-link level3">Netty ä¸»ä»å¤šçº¿ç¨‹</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#netty-ç®€å•ä½¿ç”¨-1" class="router-link-active router-link-exact-active toc-link level2">Netty ç®€å•ä½¿ç”¨</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#netty-æ¨¡å‹" class="router-link-active router-link-exact-active toc-link level1">Netty æ¨¡å‹</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#netty-ä»»åŠ¡é˜Ÿåˆ—" class="router-link-active router-link-exact-active toc-link level2">Netty ä»»åŠ¡é˜Ÿåˆ—</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#å¼‚æ­¥æ¨¡å‹" class="router-link-active router-link-exact-active toc-link level2">å¼‚æ­¥æ¨¡å‹</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#future-listener-æœºåˆ¶" class="router-link-active router-link-exact-active toc-link level3">Future-Listener æœºåˆ¶</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#ç®€å•çš„-http-æœåŠ¡" class="router-link-active router-link-exact-active toc-link level2">ç®€å•çš„ HTTP æœåŠ¡</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#pipeline-ä¸-channel" class="router-link-active router-link-exact-active toc-link level2">Pipeline ä¸ Channel</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#eventloopgroup" class="router-link-active router-link-exact-active toc-link level2">EventLoopGroup</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#netty-å¿ƒè·³æ£€æµ‹" class="router-link-active router-link-exact-active toc-link level2">Netty å¿ƒè·³æ£€æµ‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#netty-websocket-é•¿è¿æ¥" class="router-link-active router-link-exact-active toc-link level2">Netty WebSocket é•¿è¿æ¥</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#protobuf-ç¼–è§£ç å™¨" class="router-link-active router-link-exact-active toc-link level2">Protobuf ç¼–è§£ç å™¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/netty/Netty.html#å…¥æ ˆå‡ºæ ˆæœºåˆ¶" class="router-link-active router-link-exact-active toc-link level2">å…¥æ ˆå‡ºæ ˆæœºåˆ¶</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="netty-ç®€å•ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#netty-ç®€å•ä½¿ç”¨" aria-hidden="true">#</a> Netty ç®€å•ä½¿ç”¨</h1><h1 id="i-o-æ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#i-o-æ¨¡å‹" aria-hidden="true">#</a> I/O æ¨¡å‹</h1><ul><li>I/O æ¨¡å‹ç®€å•ç†è§£ï¼šç”¨ä»€ä¹ˆæ ·çš„é€šé“è¿›è¡Œæ•°æ®çš„å‘é€å’Œæ¥æ”¶ï¼Œæ¨¡å‹å¾ˆå¤§ç¨‹åº¦å†³å®šäº†ç¨‹åºé€šä¿¡çš„æ€§èƒ½</li><li>Java BIOï¼šåŒæ­¥é˜»å¡æ¨¡å‹ï¼ŒæœåŠ¡å™¨å®ç°ä¸ºä¸€ä¸ªè¿æ¥ä¸€ä¸ªçº¿ç¨‹ï¼Œå®¢æˆ·ç«¯æœ‰è¿æ¥æ—¶æœåŠ¡å™¨å°±éœ€è¦å¯åŠ¨ä¸€ä¸ªå½¢æˆè¿›è¡Œå¤„ç†ï¼Œå¦‚æœè¿™ä¸ªè¿æ¥ä¸åšä»»ä½•äº‹æƒ…å°±ä¼šé€ æˆä¸å¿…è¦çš„çº¿ç¨‹å¼€é”€ï¼›é€‚ç”¨äºè¿æ¥æ•°è¾ƒå°ä¸”å›ºå®šçš„æ¶æ„ï¼Œå¯¹æœåŠ¡å™¨èµ„æºè¦æ±‚æ¯”è¾ƒé«˜ï¼Œä½†æ˜¯ç¨‹åºç®€å•æ˜“ç†è§£</li><li>Java NIOï¼šåŒæ­¥éé˜»å¡æ¨¡å‹ï¼ŒæœåŠ¡å™¨å®ç°ä¸ºä¸€ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªè¯·æ±‚ï¼Œå®¢æˆ·ç«¯å‘é€çš„è¿æ¥è¯·æ±‚éƒ½ä¼šæ³¨å†Œåˆ°ã€Œå¤šè·¯å¤ç”¨å™¨ã€ä¸Šï¼Œå¤šè·¯å¤ç”¨å™¨è½®è¯¢åˆ°è¿æ¥æœ‰ I/O è¯·æ±‚å°±ä¼šè¿›è¡Œå¤„ç†ï¼›é€‚ç”¨äºè¿æ¥æ•°è¾ƒå¤šä¸”è¿æ¥æ¯”è¾ƒçŸ­ï¼ˆè½»æ“ä½œï¼‰çš„æ¶æ„ï¼Œæ¯”å¦‚èŠå¤©æœåŠ¡å™¨ï¼Œå¼¹å¹•ç³»ç»Ÿï¼ŒæœåŠ¡å™¨é—´é€šè®¯ã€‚ç¼–ç¨‹è¾ƒä¸ºå¤æ‚</li><li>Java AIOï¼ˆæ²¡æœ‰å¹¿æ³›ä½¿ç”¨ï¼‰ï¼šå¼‚æ­¥éé˜»å¡æ¨¡å‹ï¼Œå¼•å…¥äº†ã€Œå¼‚æ­¥é€šé“ã€çš„æ¦‚å¿µï¼Œé‡‡ç”¨ Proactor æ¨¡å¼ï¼Œç®€åŒ–äº†ç¨‹åºç¼–å†™ï¼Œæœ‰æ•ˆçš„è¯·æ±‚æ‰å¯åŠ¨çº¿ç¨‹ï¼Œç‰¹ç‚¹æ˜¯ç”±æ“ä½œç³»ç»Ÿå®Œæˆåæ‰é€šçŸ¥æœåŠ¡ç«¯ç¨‹åºå¯åŠ¨çº¿ç¨‹å¤„ç†è¯·æ±‚ï¼Œä¸€èˆ¬é€‚ç”¨äºè¿æ¥æ•°è¾ƒå¤šä¸”è¿æ¥æ—¶é—´è¾ƒé•¿çš„åº”ç”¨ï¼Œæ¯”å¦‚ç›¸å†ŒæœåŠ¡å™¨ï¼Œå……åˆ†è°ƒç”¨ OS å‚ä¸å¹¶å‘æ“ä½œï¼Œç¼–ç¨‹æ¯”è¾ƒå¤æ‚</li></ul><h1 id="nio" tabindex="-1"><a class="header-anchor" href="#nio" aria-hidden="true">#</a> NIO</h1><ul><li><p>NIO æœ‰ä¸‰å¤§æ ¸å¿ƒéƒ¨åˆ†ï¼šSelectorï¼šé€‰æ‹©å™¨ã€Channelï¼šç®¡é“ã€Bufferï¼šç¼“å†²åŒº</p></li><li><p>ä¸‰å¤§æ ¸å¿ƒçš„å…³ç³»ï¼š</p><ul><li>æ¯ä¸ª Selector éƒ½ä¼šå¯¹åº”ä¸€ä¸ª çº¿ç¨‹ï¼Œè€Œä¸€ä¸ªçº¿ç¨‹ä¼šå¯¹åº”å¤šä¸ª Channel</li><li>æ¯ä¸ª Channel éƒ½ä¼šå¯¹åº”ä¸€ä¸ª Buffer</li><li>ç¨‹åºåˆ‡æ¢åˆ°å“ªä¸ª Channel æ˜¯ç”±ã€Œäº‹ä»¶ã€å†³å®šçš„ï¼Œè¿™é‡Œçš„äº‹ä»¶ Event ä¹Ÿæ˜¯ NIO ä¸­å¾ˆé‡è¦çš„æ¦‚å¿µï¼ŒSelector ä¼šæ ¹æ®ä¸åŒçš„äº‹ä»¶åˆ‡æ¢ä¸åŒçš„ Channel</li><li>Buffer æœ¬è´¨å°±æ˜¯ä¸€ä¸ªå†…å­˜å—ï¼Œåº•å±‚éƒ½æœ‰ä¸€ä¸ªæ•°ç»„ï¼Œæ•°æ®çš„è¯»å†™éƒ½æ˜¯é€šè¿‡ Buffer çš„</li><li>Channel å’Œ Buffer éƒ½æ˜¯ã€ŒåŒå‘çš„ã€ï¼Œå‰è€…å¾ˆå¥½åœ°åæ˜ äº†åº•å±‚æ“ä½œç³»ç»Ÿçš„æƒ…å†µï¼Œåè€…çš„åˆ‡æ¢éœ€è¦é€šè¿‡ <code>flip()</code> æ–¹æ³•å®ç°</li></ul></li><li><p>NIO æ˜¯é¢å‘ã€Œç¼“å†²åŒºã€æˆ–è€…é¢å‘ã€Œå—ã€ç¼–ç¨‹çš„ï¼Œæ•°æ®è¯»å–åˆ°ä¸€ä¸ªç¨åå¤„ç†çš„ç¼“å†²åŒºä¸­ï¼Œéœ€è¦æ—¶å¯åœ¨ç¼“å†²åŒºä¸­å‰åç§»åŠ¨ï¼Œè¿™æ ·å¢åŠ äº†å¤„ç†è¿‡ç¨‹ä¸­çš„çµæ´»æ€§ï¼Œä½¿ç”¨å®ƒå¯ä»¥æä¾›éé˜»å¡å¼çš„ã€Œä¼¸ç¼©æ€§ç½‘æ ¼ã€</p></li><li><p>NIO çš„éé˜»å¡æ¨¡å¼ï¼ˆå¤šè·¯å¤ç”¨ï¼‰ï¼Œä½¿ä¸€ä¸ªçº¿ç¨‹ä»æŸé€šé“å‘é€è¯·æ±‚æˆ–è€…è¯»å–æ•°æ®ï¼Œä½†æ˜¯è¿™ä»…èƒ½è¯»å–åˆ°ç›®å‰å¯ç”¨çš„æ•°æ®ï¼Œå¦‚æœç›®å‰æ²¡æœ‰æ•°æ®å¯ç”¨ï¼Œå°±ä»€ä¹ˆéƒ½ä¸ä¼šè·å–ï¼Œè€Œä¸æ˜¯ä¿æŒçº¿ç¨‹é˜»å¡ï¼Œè¿™æ ·çº¿ç¨‹å°±å¯ä»¥å¤„ç†å…¶ä»–äº‹æƒ…</p></li><li><p>BIO æ˜¯ä»¥ã€Œæµã€çš„æ–¹å¼å¤„ç†æ•°æ®çš„ï¼Œè€Œ NIO æ˜¯åŸºäº Channel å’Œ Buffer è¿›è¡Œæ“ä½œçš„ï¼Œæ•°æ®æ€»æ˜¯ä»é€šé“è¯»å–åˆ°ç¼“å†²åŒºä¸­ï¼Œæˆ–è€…ä»ç¼“å†²åŒºå†™å…¥åˆ°é€šé“ä¸­ï¼›Selector ç”¨äºç›‘å¬å¤šä¸ªé€šé“çš„äº‹ä»¶ï¼Œæ¯”å¦‚è¿æ¥è¯·æ±‚ã€æ•°æ®åˆ°è¾¾ç­‰ï¼Œå› æ­¤ä½¿ç”¨å•ä¸ªçº¿ç¨‹å°±å¯ä»¥ç›‘å¬åˆ°å¤šä¸ªå®¢æˆ·ç«¯é€šé“</p></li></ul><h2 id="buffer" tabindex="-1"><a class="header-anchor" href="#buffer" aria-hidden="true">#</a> Buffer</h2><ul><li>ç¼“å†²åŒºæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå¯ä»¥ã€Œè¯»å†™æ•°æ®ã€çš„ã€Œå†…å­˜å—ã€ï¼Œå¯ä»¥ç†è§£æˆä¸€ä¸ªå®¹å™¨å¯¹è±¡ï¼Œåº•å±‚æ˜¯æ•°ç»„ï¼Œè¯¥å¯¹è±¡æä¾›äº†ä¸€ç»„æ–¹æ³•ï¼Œä»¥ä¾¿è½»æ¾åœ°ä½¿ç”¨å†…å­˜å—</li><li>ç¼“å†²åŒºå¯¹è±¡è¿˜å†…ç½®äº†ä¸€äº›ã€Œæœºåˆ¶ã€ï¼Œèƒ½å¤Ÿè·Ÿè¸ªå’Œè®°å½•ç¼“å†²åŒºçš„ã€ŒçŠ¶æ€å˜åŒ–ã€æƒ…å†µ</li><li>åœ¨ NIO ä¸­ï¼ŒBuffer æ˜¯ä¸€ä¸ªã€Œé¡¶å±‚çˆ¶ç±»ã€ï¼Œæ˜¯ä¸€ä¸ªã€ŒæŠ½è±¡ç±»ã€ï¼ŒåŸºç¡€ç±»å‹éƒ½æœ‰å¯¹åº”çš„ Buffer ç±»ï¼ˆé™¤äº†å¸ƒå°”ç±»å‹ï¼‰</li><li>Buffer ç±»å®šä¹‰äº†æ‰€æœ‰ç¼“å†²åŒºéƒ½å…·æœ‰çš„ã€Œå››ä¸ªå±æ€§ã€ï¼Œè¿™äº›å±æ€§ç”¨äºæä¾›å…³äºå…¶æ‰€åŒ…å«çš„æ•°æ®å…ƒç´ çš„ã€Œä¿¡æ¯ã€ï¼Œå››ä¸ªå±æ€§å¦‚ä¸‹ï¼š <ul><li>markï¼šæ ‡å¿—ä½</li><li>positionï¼šä¸‹ä¸€ä¸ªè¦è¢«è¯»æˆ–å†™çš„å…ƒç´ çš„ã€Œç´¢å¼•ã€ï¼Œæ¯æ¬¡è¯»å†™ç¼“å†²åŒºæ•°æ®æ—¶éƒ½ä¼šæ”¹å˜è¯¥ç´¢å¼•çš„ä½ç½®</li><li>limitï¼šè¡¨ç¤ºç¼“å†²åŒºçš„å½“å‰ç»ˆç‚¹ï¼Œå³ä¸èƒ½å¯¹ç¼“å†²åŒºè¶…è¿‡æé™çš„ä½ç½®è¿›è¡Œè¯»å†™æ“ä½œï¼Œä½†æ˜¯è¿™ä¸ªæé™æ˜¯å¯ä»¥ä¿®æ”¹çš„</li><li>capacityï¼šå®¹é‡ï¼Œå³å¯ä»¥å®¹çº³çš„æœ€å¤§æ•°æ®é‡ï¼Œåœ¨ç¼“å†²åŒºåˆ›å»ºæ—¶å°±è¢«è®¾å®šå¹¶ä¸”ä¸èƒ½æ”¹å˜</li></ul></li><li>Buffer å¯ä»¥ä½¿ç”¨æ–¹æ³• <code>asReadOnlyBuffer()</code> æ‰‹åŠ¨è½¬æ¢æˆã€Œåªè¯»ç¼“å†²åŒºã€ï¼Œè¯»å–çš„æ—¶å€™è¿˜å¿…é¡»æŒ‰ç…§å†™å…¥ç±»å‹çš„é¡ºåºè¿›è¡Œç›¸åº”ï¼Œå¦åˆ™ä¼šæŠ›å¼‚å¸¸</li></ul><h3 id="åŸºæœ¬ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬ä½¿ç”¨" aria-hidden="true">#</a> åŸºæœ¬ä½¿ç”¨</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BasicBuffer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// åˆ›å»ºä¸€ä¸ª Buffer</span>
        <span class="token class-name">IntBuffer</span> intBuffer <span class="token operator">=</span> <span class="token class-name">IntBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å‘ Buffer ä¸­å­˜æ”¾æ•°æ®</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> intBuffer<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            intBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// ä» Buffer ä¸­è¯»å–æ•°æ®ï¼Œéœ€è¦å…ˆå°† Buffer è½¬æ¢ï¼Œå³è¯»å†™åˆ‡æ¢</span>
        intBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>intBuffer<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>intBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="mappedbytebuffer" tabindex="-1"><a class="header-anchor" href="#mappedbytebuffer" aria-hidden="true">#</a> MappedByteBuffer</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * ç›´æ¥åœ¨å†…å­˜ä¸­ä¿®æ”¹æ–‡ä»¶
 * MappedByteBuffer å¯ä»¥è®©æ–‡ä»¶ç›´æ¥åœ¨å†…å­˜ä¿®æ”¹ï¼ˆå †å¤–å†…å­˜ï¼‰ï¼Œè¿™æ ·æ“ä½œç³»ç»Ÿä¸ç”¨æ‹·è´ä¸€æ¬¡
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NIOFileChannel05</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">RandomAccessFile</span> randomAccessFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span><span class="token string">&quot;xxx.xxx&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rw&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è·å–å¯¹åº”çš„é€šé“</span>
        <span class="token class-name">FileChannel</span> channel <span class="token operator">=</span> randomAccessFile<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * ä¸‰ä¸ªå‚æ•°çš„å«ä¹‰ä¾æ¬¡ä¸ºï¼š
         * 1ã€ä½¿ç”¨è¯»å†™æ¨¡å¼
         * 2ã€å¯ä»¥ç›´æ¥ä¿®æ”¹çš„èµ·å§‹ä½ç½®
         * 3ã€æ˜ å°„åˆ°å†…å­˜ä¸­çš„å¤§å°ï¼Œå³å°†æ–‡ä»¶çš„å¤šå°‘ä¸ªå­—èŠ‚æ˜ å°„åˆ°å†…å­˜ä¸­
         * å³å¯ä»¥ä¿®æ”¹çš„èŒƒå›´å°±æ˜¯ 0 ~ 5ï¼ˆä¸åŒ…å« 5ï¼‰
         * MappedByteBuffer çš„å®é™…ç±»å‹æ˜¯ DirectByteBuffer
         */</span>
        <span class="token class-name">MappedByteBuffer</span> mappedByteBuffer <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">FileChannel<span class="token punctuation">.</span>MapMode</span><span class="token punctuation">.</span><span class="token constant">READ_WRITE</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ä¿®æ”¹æ–‡ä»¶</span>
        mappedByteBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token char">&#39;H&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å…³é—­æµ</span>
        randomAccessFile<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="channel" tabindex="-1"><a class="header-anchor" href="#channel" aria-hidden="true">#</a> Channel</h2><ul><li>Channel æ˜¯åŒå‘çš„ï¼Œå¯ä»¥è¿›è¡Œè¯»å†™æ“ä½œï¼Œåœ¨ NIO ä¸­æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¸¸ç”¨çš„ Channel ç±»æœ‰ï¼š <ul><li><code>FileChannel</code>ï¼šç”¨äºæ–‡ä»¶çš„æ•°æ®è¯»å†™</li><li><code>DatagramChannel</code>ï¼šç”¨äº UDP çš„æ•°æ®è¯»å†™</li><li><code>ServerSocketChannel</code> å’Œ <code>SocketChannel</code>ï¼šç”¨äº TCP çš„æ•°æ®è¯»å†™</li></ul></li></ul><h3 id="åŸºæœ¬ä½¿ç”¨-1" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬ä½¿ç”¨-1" aria-hidden="true">#</a> åŸºæœ¬ä½¿ç”¨</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NIOFileChannel01</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">&quot;hello world&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆ›å»ºä¸€ä¸ªè¾“å‡ºæµ</span>
        <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">&quot;xxx.xxx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è·å–å¯¹åº”çš„ FileChannel</span>
        <span class="token class-name">FileChannel</span> fileChannel <span class="token operator">=</span> fileOutputStream<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆ›å»ºä¸€ä¸ª byte ç¼“å†²åŒº</span>
        <span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å°†ä¿¡æ¯æ”¾å…¥ç¼“å†²åŒº</span>
        byteBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ç¼“å†²åŒºåè½¬ï¼Œposition=0ï¼Œlimit=ä¿¡æ¯çš„å­—èŠ‚æ•°ï¼Œè¿™æ ·å†™å…¥å°±ä¸ä¼šå‡ºé”™</span>
        byteBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å°†ç¼“å†²åŒºçš„æ•°æ®å†™å…¥ channel</span>
        fileChannel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å…³é—­æµ</span>
        fileOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="scatteringandgathering" tabindex="-1"><a class="header-anchor" href="#scatteringandgathering" aria-hidden="true">#</a> ScatteringAndGathering</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Scatteringï¼šå°†æ•°æ®å†™å…¥åˆ° Buffer æ—¶ï¼Œå¯ä»¥é‡‡ç”¨ Buffer æ•°ç»„ï¼Œä¾æ¬¡å†™å…¥ï¼ˆåˆ†æ•£å†™å…¥ï¼‰
 * Gatheringï¼šä» Buffer è¯»å–æ•°æ®æ—¶ï¼Œå¯ä»¥é‡‡ç”¨ Buffer æ•°ç»„ï¼Œä¾æ¬¡è¯»å‡ºï¼ˆåˆ†æ•£è¯»å‡ºï¼‰
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScatteringAndGathering</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä½¿ç”¨ ServerSocketChannel å’Œ SocketChannel ç½‘ç»œ</span>
        <span class="token class-name">ServerSocketChannel</span> serverSocketChannel <span class="token operator">=</span> <span class="token class-name">ServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">InetSocketAddress</span> inetSocketAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token number">7000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ç»‘å®šç«¯å£å¹¶å¯åŠ¨</span>
        serverSocketChannel<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>inetSocketAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆ›å»º Buffer æ•°ç»„</span>
        <span class="token class-name">ByteBuffer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> byteBuffers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        byteBuffers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        byteBuffers<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥</span>
        <span class="token class-name">SocketChannel</span> socketChannel <span class="token operator">=</span> serverSocketChannel<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å‡å®šä»å®¢æˆ·ç«¯æ¥æ”¶ 8 ä¸ªå­—èŠ‚</span>
        <span class="token keyword">int</span> messageLength <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token comment">// å¾ªç¯è¯»å–</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> byteRead <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>byteRead <span class="token operator">&lt;</span> messageLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> l <span class="token operator">=</span> socketChannel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>byteBuffers<span class="token punctuation">)</span><span class="token punctuation">;</span>
                byteRead <span class="token operator">+=</span> l<span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;byteRead: &quot;</span> <span class="token operator">+</span> byteRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// è¾“å‡ºå½“å‰ Buffer çš„ position å’Œ limit</span>
                <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>byteBuffers<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>buffer <span class="token operator">-&gt;</span> <span class="token string">&quot;position: &quot;</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;; limit: &quot;</span> <span class="token operator">+</span> buffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// å°†æ‰€æœ‰çš„ Buffer è¿›è¡Œåè½¬</span>
            <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>byteBuffers<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>byteBuffer <span class="token operator">-&gt;</span> byteBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å°†æ•°æ®å›æ˜¾åˆ°å®¢æˆ·ç«¯</span>
            <span class="token keyword">long</span> byteWrite <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>byteWrite <span class="token operator">&lt;</span> messageLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> l <span class="token operator">=</span> socketChannel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>byteBuffers<span class="token punctuation">)</span><span class="token punctuation">;</span>
                byteWrite <span class="token operator">+=</span> l<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// å°†æ‰€æœ‰çš„ Buffer å¤ä½</span>
            <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>byteBuffers<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>byteBuffer <span class="token operator">-&gt;</span> byteBuffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;byteRead: &quot;</span> <span class="token operator">+</span> byteRead <span class="token operator">+</span> <span class="token string">&quot;; byteWrite: &quot;</span> <span class="token operator">+</span> byteWrite <span class="token operator">+</span> <span class="token string">&quot;; messageLength: &quot;</span> <span class="token operator">+</span> messageLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="selector" tabindex="-1"><a class="header-anchor" href="#selector" aria-hidden="true">#</a> Selector</h2><ul><li><p>Selector æ˜¯å¤šè·¯å¤ç”¨å™¨ï¼Œæ˜¯ Java NIO æ ¸å¿ƒç»„ä»¶ä¸­çš„ç”¨äºæ£€æŸ¥ä¸€ä¸ªæˆ–è€…å¤šä¸ª Channel çš„çŠ¶æ€æ˜¯å¦å¤„äºå¯è¯»æˆ–è€…å¯å†™</p></li><li><p>ä½¿ç”¨ Selector çš„å¥½å¤„åœ¨äºï¼Œå¯ä»¥ä½¿ç”¨æ›´å°‘çš„çº¿ç¨‹æ¥å¤„ç†é€šé“ï¼Œé¿å…äº†ä¸Šä¸‹æ–‡åˆ‡æ¢å¸¦æ¥çš„å¼€é”€</p></li><li><p>ä½†æ˜¯æ³¨æ„ï¼Œä¸æ˜¯æ‰€æœ‰çš„ Channel éƒ½å¯ä»¥è¢« Selector å¤ç”¨ï¼Œæ¯”å¦‚ FileChannel å°±ä¸èƒ½è¢«å¤ç”¨ï¼›åˆ¤æ–­ä¸€ä¸ª Channel æ˜¯å¦èƒ½è¢«å¤ç”¨ï¼Œå‰ææ˜¯å®ƒæ˜¯å¦ç»§æ‰¿äº†æŠ½è±¡ç±» <code>SelectableChannel</code>ï¼Œé›†æˆå³å¯å¤ç”¨ï¼Œå¦åˆ™ä¸èƒ½</p></li><li><p><code>SelectableChannel</code> ç±»æä¾›äº†å®ç°é€šé“çš„ã€Œå¯é€‰æ‹©æ€§ã€çš„å…¬å…±æ–¹æ³•ï¼Œè¿™æ˜¯æ‰€æœ‰æ”¯æŒã€Œå°±ç»ªæ£€æŸ¥ã€çš„é€šé“ç±»çš„ã€Œçˆ¶ç±»ã€ï¼›æ‰€æœ‰çš„ Socket é€šé“éƒ½æ˜¯å¯é€‰æ‹©çš„ï¼ŒåŒ…æ‹¬ä»ã€Œç®¡é“ï¼ˆPipeï¼‰ã€å¯¹è±¡ä¸­è·å¾—çš„é€šé“</p></li><li><p>é€‰æ‹©å™¨å’Œé€šé“ä¹‹é—´ä½¿ç”¨ã€Œæ³¨å†Œã€çš„æ–¹å¼å®Œæˆè”ç³»ï¼›ä¸€ä¸ªé€šé“å¯ä»¥è¢«æ³¨å†Œåˆ°ã€Œå¤šä¸ªé€‰æ‹©å™¨ã€ä¸Šï¼Œä½†æ˜¯å¯¹æ¯ä¸ªé€‰æ‹©å™¨è€Œè¨€åªèƒ½è¢«æ³¨å†Œä¸€æ¬¡ï¼›åœ¨æ³¨å†Œæ—¶ï¼Œéœ€è¦æŒ‡å®šé€šé“çš„å“ªäº›æ“ä½œæ˜¯é€‰æ‹©å™¨å…³å¿ƒçš„</p></li><li><p>é€šé“æ“ä½œåŒ…æ‹¬ä»¥ä¸‹å››ç§ï¼š</p><ul><li>å¯è¯»ï¼š<code>SelectionKey.OP_READ</code></li><li>å¯å†™ï¼š<code>SelectionKey.OP_WRITE</code></li><li>è¿æ¥ï¼š<code>SelectionKey.OP_CONNECT</code></li><li>æ¥æ”¶ï¼š<code>SelectionKey.OP_ACCEPT</code></li></ul></li><li><p>å¦‚æœé€šé“å¯¹å¤šæ“ä½œæ„Ÿå…´è¶£ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡ã€Œä½æˆ–ã€æ“ä½œç¬¦æ¥å®ç°ï¼Œå¦‚ï¼š<code>int key = SelectionKey.OP_READ |SelectionKey.OP_WRITE </code></p></li><li><p>é€‰æ‹©å™¨æŸ¥è¯¢çš„ä¸æ˜¯é€šé“çš„ã€Œæ“ä½œã€ï¼Œè€Œæ˜¯é€šé“çš„æŸä¸€ä¸ªæ“ä½œçš„ä¸€ç§ã€Œå°±ç»ªçŠ¶æ€ã€ï¼Œè¿™é‡Œçš„å°±ç»ªçŠ¶æ€æ˜¯æŒ‡ï¼Œä¸€æ—¦é€šé“å…·å¤‡å®ŒæˆæŸä¸ªæ“ä½œçš„æ¡ä»¶ï¼Œå°±è¡¨ç¤ºè¯¥é€šé“çš„æŸä¸ªæ“ä½œã€Œå°±ç»ªã€ï¼Œæ­¤æ—¶å°±å¯ä»¥è¢«é€‰æ‹©å™¨æŸ¥è¯¢åˆ°ï¼Œç¨‹åºå°±å¯ä»¥å¯¹é€šé“è¿›è¡Œç›¸åº”çš„æ“ä½œ</p></li></ul><h3 id="åŸºæœ¬ä½¿ç”¨-2" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬ä½¿ç”¨-2" aria-hidden="true">#</a> åŸºæœ¬ä½¿ç”¨</h3><p><strong>æœåŠ¡ç«¯ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NIOServer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// åˆ›å»ºé€šé“</span>
        <span class="token class-name">ServerSocketChannel</span> serverSocketChannel <span class="token operator">=</span> <span class="token class-name">ServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è·å–é€‰æ‹©å™¨å¯¹è±¡</span>
        <span class="token class-name">Selector</span> selector <span class="token operator">=</span> <span class="token class-name">Selector</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ç»‘å®šä¸€ä¸ªç«¯å£</span>
        serverSocketChannel<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token number">6666</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è®¾ç½®ä¸ºéé˜»å¡</span>
        serverSocketChannel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æŠŠ serverSocketChannel æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸Š</span>
        serverSocketChannel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_ACCEPT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å¾ªç¯ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ²¡æœ‰ä»»ä½•äº‹æƒ…å‘ç”Ÿ</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ç­‰å¾…1ç§’ï¼Œæ— è¿æ¥...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// å¦‚æœæœ‰äº‹ä»¶å‘ç”Ÿï¼Œå¯ä»¥é€šè¿‡ selectionKeys åå‘è·å–é€šé“</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> selectionKeys <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// éå†é›†åˆ</span>
            <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> keysIterator <span class="token operator">=</span> selectionKeys<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>keysIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// è·å– key</span>
                <span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> keysIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// æ ¹æ® key è·å–ç›¸åº”çš„é€šé“å¹¶åšå‡ºç›¸åº”çš„å¤„ç†</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isAcceptable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// è¿™é‡Œè¡¨ç¤ºæœ‰æ–°çš„å®¢æˆ·ç«¯è¿æ¥</span>
                    <span class="token class-name">SocketChannel</span> socketChannel <span class="token operator">=</span> serverSocketChannel<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// è®¾ç½®æˆéé˜»å¡çš„ï¼Œå¦åˆ™ä¼šæŠ¥é”™</span>
                    socketChannel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æˆåŠŸè¿æ¥äº†ä¸€ä¸ªå®¢æˆ·ç«¯...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// å°†å½“å‰çš„ socketChannel ä¹Ÿæ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸Šï¼Œå…³å¿ƒçš„äº‹ä»¶ä¸ºè¯»äº‹ä»¶ï¼Œå¹¶å…³è”ä¸€ä¸ª Buffer</span>
                    socketChannel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_READ</span><span class="token punctuation">,</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// å¦‚æœæ˜¯å¯è¯»çš„ï¼Œè·å–åˆ°è¯¥å¯è¯»çš„ç®¡é“</span>
                    <span class="token class-name">SocketChannel</span> channel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SocketChannel</span><span class="token punctuation">)</span>key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// è·å–åˆ°è¿™ä¸ªç®¡é“å…³è”çš„ Buffer</span>
                    <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">)</span>key<span class="token punctuation">.</span><span class="token function">attachment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;From Client: &quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// æ‰‹åŠ¨ä»é›†åˆä¸­åˆ é™¤å½“å‰çš„ keyï¼Œé˜²æ­¢å¤šçº¿ç¨‹ä¸‹é‡å¤æ“ä½œ</span>
                keysIterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å®¢æˆ·ç«¯ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NIOClient</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–é€šé“</span>
        <span class="token class-name">SocketChannel</span> socketChannel <span class="token operator">=</span> <span class="token class-name">SocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è®¾ç½®éé˜»å¡</span>
        socketChannel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æŒ‡å®šæœåŠ¡ç«¯çš„ ip å’Œç«¯å£</span>
        <span class="token class-name">InetSocketAddress</span> inetSocketAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">6666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è¿æ¥æœåŠ¡å™¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>socketChannel<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>inetSocketAddress<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>socketChannel<span class="token punctuation">.</span><span class="token function">finishConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;è¿æ¥éœ€è¦äº‹ä»¶ï¼Œå®¢æˆ·ç«¯ä¸é˜»å¡ï¼Œå¯ä»¥ç»§ç»­å…¶ä»–å·¥ä½œ...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// è¿æ¥æˆåŠŸï¼Œå‘é€ä¿¡æ¯</span>
        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">&quot;Hello world&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        socketChannel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="èŠå¤©å®¤" tabindex="-1"><a class="header-anchor" href="#èŠå¤©å®¤" aria-hidden="true">#</a> èŠå¤©å®¤</h3><p><strong>æœåŠ¡ç«¯ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GroupChatServer</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * é€‰æ‹©å™¨
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Selector</span> selector<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * ç›‘å¬é€šé“
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">ServerSocketChannel</span> listenChannel<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * ç›‘å¬ç«¯å£
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">PORT</span> <span class="token operator">=</span> <span class="token number">6667</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">GroupChatServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>selector <span class="token operator">=</span> <span class="token class-name">Selector</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>listenChannel <span class="token operator">=</span> <span class="token class-name">ServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ç»‘å®šç«¯å£</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>listenChannel<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è®¾ç½®éé˜»å¡</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>listenChannel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å°†ç®¡é“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸Š</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>listenChannel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_ACCEPT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * ç›‘å¬æ–¹æ³•
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// å¾ªç¯å¤„ç†</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// è¯´æ˜æœ‰äº‹æƒ…éœ€è¦å¤„ç†</span>
                    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// è·å– key</span>
                        <span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isAcceptable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">SocketChannel</span> sc <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>listenChannel<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            sc<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// æ³¨å†Œ</span>
                            sc<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_READ</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// è¾“å‡ºæç¤º</span>
                            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sc<span class="token punctuation">.</span><span class="token function">getRemoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; ä¸Šçº¿...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">// é€šé“å¯è¯»æ—¶</span>
                            <span class="token function">readData</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment">// åˆ é™¤ keyï¼Œé˜²æ­¢é‡å¤å¤„ç†</span>
                        iterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// TODO</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * è¯»å–æ•°æ®
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">readData</span><span class="token punctuation">(</span><span class="token class-name">SelectionKey</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SocketChannel</span> channel <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            channel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SocketChannel</span><span class="token punctuation">)</span> key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// åˆ›å»º Buffer</span>
            <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> count <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// è¯»å–åˆ°äº†æ•°æ®</span>
                <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;From Client: &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// å‘å…¶ä»–å®¢æˆ·ç«¯è½¬å‘æ¶ˆæ¯ï¼Œè¦æ’é™¤è‡ªå·±</span>
                <span class="token function">sendToClients</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">getRemoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; ç¦»çº¿äº†...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// å–æ¶ˆæ³¨å†Œ</span>
                key<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// å…³é—­é€šé“</span>
                channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * å‘å…¶ä»–å®¢æˆ·ç«¯è½¬å‘æ¶ˆæ¯
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendToClients</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">,</span> <span class="token class-name">SocketChannel</span> self<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡å™¨è½¬å‘æ¶ˆæ¯...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">SelectionKey</span> key <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Channel</span> targetChannel <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ’é™¤è‡ªå·±</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>targetChannel <span class="token keyword">instanceof</span> <span class="token class-name">SocketChannel</span> <span class="token operator">&amp;&amp;</span> targetChannel <span class="token operator">!=</span> self<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">SocketChannel</span> dest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SocketChannel</span><span class="token punctuation">)</span> targetChannel<span class="token punctuation">;</span>
                <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// å°†æ•°æ®å†™å…¥é€šé“</span>
                dest<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¯åŠ¨æœåŠ¡å™¨</span>
        <span class="token class-name">GroupChatServer</span> chatServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GroupChatServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        chatServer<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å®¢æˆ·ç«¯ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GroupChatClient</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">HOST</span> <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">PORT</span> <span class="token operator">=</span> <span class="token number">6667</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Selector</span> selector<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">SocketChannel</span> socketChannel<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">GroupChatClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>selector <span class="token operator">=</span> <span class="token class-name">Selector</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è¿æ¥æœåŠ¡å™¨</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>socketChannel <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>socketChannel<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token constant">HOST</span><span class="token punctuation">,</span> <span class="token constant">PORT</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è®¾ç½®éé˜»å¡</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>socketChannel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ³¨å†Œ</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>socketChannel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_READ</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è·å– username</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>username <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>socketChannel<span class="token punctuation">.</span><span class="token function">getLocalAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>username <span class="token operator">+</span> <span class="token string">&quot; å‡†å¤‡å°±ç»ª...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendInfo</span><span class="token punctuation">(</span><span class="token class-name">String</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        info <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>username <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> info<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>socketChannel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * è¯»å–ä»æœåŠ¡ç«¯è¿”å›çš„æ¶ˆæ¯
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">readInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> readChannels <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>readChannels <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">SocketChannel</span> sc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SocketChannel</span><span class="token punctuation">)</span> key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// è¯»å–æ¶ˆæ¯</span>
                        sc<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// åˆ é™¤ keyï¼Œé˜²æ­¢é‡å¤æ“ä½œ</span>
                iterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// TODO</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¯åŠ¨å®¢æˆ·ç«¯</span>
        <span class="token class-name">GroupChatClient</span> chatClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GroupChatClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    chatClient<span class="token punctuation">.</span><span class="token function">readInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å‘é€æ•°æ®ç»™æœåŠ¡ç«¯</span>
        <span class="token class-name">Scanner</span> scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>scanner<span class="token punctuation">.</span><span class="token function">hasNextLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> s <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">nextLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            chatClient<span class="token punctuation">.</span><span class="token function">sendInfo</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="é›¶æ‹·è´" tabindex="-1"><a class="header-anchor" href="#é›¶æ‹·è´" aria-hidden="true">#</a> é›¶æ‹·è´</h2><ul><li><p>é›¶æ‹·è´æ˜¯ç½‘ç»œç¼–ç¨‹çš„å…³é”®ï¼Œå¾ˆå¤šæ€§èƒ½ä¼˜åŒ–éƒ½ç¦»ä¸å¼€é›¶æ‹·è´ï¼›å¸¸ç”¨çš„é›¶æ‹·è´æœ‰ <code>mmap</code>ï¼ˆå†…å­˜æ˜ å°„ï¼‰å’Œ <code>sendFile</code>ï¼Œå‰è€…é€‚åˆå°æ•°æ®é‡çš„è¯»å†™ï¼Œåè€…é€‚åˆå¤§æ–‡ä»¶çš„ä¼ è¾“</p></li><li><p>ä¼ ç»Ÿ IO æ“ä½œæ˜¯ä½¿ç”¨ DMAï¼ˆç›´æ¥å†…å­˜æ‹·è´ï¼Œä¸ä½¿ç”¨ CPUï¼‰ï¼Œè¿‡ç¨‹ç»å†äº† 4 æ¬¡æ‹·è´ 3 æ¬¡åˆ‡æ¢</p></li><li><p>è¿™é‡Œè¯´çš„é›¶æ‹·è´ä¸æ˜¯çœŸæ­£çš„é›¶æ‹·è´ï¼Œè€Œæ˜¯ä»æ“ä½œç³»ç»Ÿçš„è§’åº¦çœ‹çš„ï¼Œå³æ²¡æœ‰ CPU æ‹·è´ï¼ˆ4 æ¬¡æ‹·è´ä¼˜åŒ–æˆäº† 3 æ¬¡ï¼‰</p></li><li><p><code>mmap</code> é€šè¿‡å†…å­˜æ˜ å°„ï¼Œå°†æ–‡ä»¶æ˜ å°„åˆ°ã€Œå†…æ ¸ç¼“å†²åŒºã€ï¼Œç”¨æˆ·ç©ºé—´å¯ä»¥ç›´æ¥ã€Œå…±äº«ã€å†…æ ¸ç©ºé—´çš„æ•°æ®ï¼Œè¿™æ ·åœ¨ç½‘ç»œä¼ è¾“çš„è¿‡ç¨‹ä¸­å°±å¯ä»¥å‡å°‘å†…æ ¸ç©ºé—´åˆ°ç”¨æˆ·ç©ºé—´çš„æ‹·è´</p></li><li><p><code>sendFile</code> ä¼˜åŒ–ä¸‹ï¼Œæ•°æ®ä¸ä¼šç»è¿‡ç”¨æˆ·æ€ï¼Œè€Œæ˜¯ç›´æ¥ä»å†…æ ¸ç¼“å†²åŒºè¿›å…¥åˆ° Socket Bufferï¼ŒåŒæ—¶ï¼Œç”±äºä¸ç”¨æˆ·æ€å®Œå…¨æ— å…³ï¼Œè¿™æ ·è¿˜å¯ä»¥å‡å°‘ä¸€æ¬¡ä¸Šä¸‹æ–‡çš„åˆ‡æ¢ï¼Œå³å˜æˆäº† 3 æ¬¡æ‹·è´ 2 æ¬¡åˆ‡æ¢</p></li></ul><h1 id="netty-ç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#netty-ç®€ä»‹" aria-hidden="true">#</a> Netty ç®€ä»‹</h1><ul><li>Netty æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ã€åŸºäºäº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨æ¡†æ¶ï¼Œç”¨ä»¥å¿«é€Ÿå¼€å‘é«˜æ€§èƒ½ã€é«˜å¯é çš„ç½‘ç»œ IO ç¨‹åºï¼Œç®€åŒ–äº† NIO çš„å¼€å‘æµç¨‹</li><li>Netty ä¸»è¦é’ˆå¯¹åœ¨ TCP åè®®ä¸‹ï¼Œé¢å‘ Clients ç«¯çš„é«˜å¹¶å‘åº”ç”¨ï¼Œæˆ–è€… Peer-to-Peer åœºæ™¯ä¸‹çš„å¤§é‡æ•°æ®æŒç»­ä¼ è¾“çš„åº”ç”¨</li><li>Netty æœ¬è´¨æ˜¯ä¸€ä¸ª NIO æ¡†æ¶ï¼Œé€‚ç”¨äºæœåŠ¡å™¨é€šè®¯ç›¸å…³çš„å¤šç§åº”ç”¨åœºæ™¯</li><li>Netty æ˜¯é«˜æ€§èƒ½çš„ç½‘ç»œé€šä¿¡æ¡†æ¶ï¼Œè®¸å¤šé«˜æ€§èƒ½çš„ RPC æ¡†æ¶å’Œå¤§æ•°æ®æ¡†æ¶éƒ½ä¼šä½¿ç”¨ Netty ä½œä¸ºé€šä¿¡ç»„ä»¶</li><li>ç›®å‰å­˜åœ¨çš„çº¿ç¨‹æ¨¡å‹æœ‰ï¼šä¼ ç»Ÿé˜»å¡ I/O æœåŠ¡æ¨¡å‹ã€Reactor æ¨¡å¼ï¼Œåè€…åˆæ ¹æ® Reactor çš„æ•°é‡å’Œå¤„ç†èµ„æºæ± çº¿ç¨‹çš„æ•°é‡ä¸åŒï¼Œæœ‰ä¸‰ç§å…¸å‹çš„è¡¨ç°ï¼š <ul><li>å• Reactor å•çº¿ç¨‹</li><li>å• Reactor å¤šçº¿ç¨‹</li><li>ä¸»ä» Reactor å¤šçº¿ç¨‹</li></ul></li><li>Netty çº¿ç¨‹æ¨¡å¼ä¸»è¦æ˜¯ä»ä¸»ä» Reactor å¤šçº¿ç¨‹æ¨¡å‹åšå‡ºäº†ä¸€å®šçš„æ”¹è¿›ï¼ˆæœ‰å¤šä¸ª Reactorï¼‰</li></ul><h2 id="reactor-æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#reactor-æ¨¡å¼" aria-hidden="true">#</a> Reactor æ¨¡å¼</h2><ul><li>Reactor æ¨¡å¼åˆç§°ä¸ºååº”å™¨æ¨¡å¼ã€åˆ†å‘è€…æ¨¡å¼ã€é€šçŸ¥è€…æ¨¡å¼</li><li>åŸºäº I/O å¤ç”¨æ¨¡å‹ï¼šå¤šä¸ªè¿æ¥å…±ç”¨ä¸€ä¸ªã€Œé˜»å¡å¯¹è±¡ã€ï¼Œåº”ç”¨ç¨‹åºåªéœ€è¦åœ¨ä¸€ä¸ªé˜»å¡å¯¹è±¡ç­‰å¾…ï¼Œæ— éœ€é˜»å¡ç­‰å¾…æ‰€æœ‰è¿æ¥ï¼Œå½“æŸä¸ªè¿æ¥æœ‰æ–°çš„æ•°æ®å¯ä»¥å¤„ç†æ—¶ï¼Œæ“ä½œç³»ç»Ÿé€šçŸ¥åº”ç”¨ç¨‹åºï¼Œçº¿ç¨‹ä»é˜»å¡çŠ¶æ€è¿”å›ï¼Œå¼€å§‹è¿›è¡Œä¸šåŠ¡å¤„ç†</li><li>åŸºäºçº¿ç¨‹æ± å¤ç”¨çº¿ç¨‹èµ„æºï¼šä¸å¿…å†ä¸ºæ¯ä¸ªè¿æ¥åˆ›å»ºçº¿ç¨‹ï¼Œå°†è¿æ¥å®Œæˆåçš„ä¸šåŠ¡å¤„ç†ä»»åŠ¡åˆ†é…ç»™çº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤„ç†å¤šä¸ªè¿æ¥ä¸šåŠ¡</li><li>Reactor æ¨¡å¼ä½¿ç”¨ I/O å¤ç”¨ç›‘å¬äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åï¼Œåˆ†ç»™æŸä¸ªçº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œè¿›è€Œè¾¾åˆ°é«˜å¹¶å‘</li><li>Reactor æ ¸å¿ƒç»„æˆï¼š <ul><li>Reactorï¼šåœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸­è¿è¡Œï¼Œè´Ÿè´£ã€Œç›‘å¬ã€å’Œã€Œåˆ†å‘ã€äº‹ä»¶ï¼Œåˆ†å‘ç»™é€‚å½“çš„å¤„ç†ç¨‹åºå¯¹ I/O äº‹ä»¶åšå‡ºååº”</li><li>Handlersï¼šå¤„ç†ç¨‹åºæ‰§è¡Œ I/O äº‹ä»¶è¦å®Œæˆçš„å®é™…äº‹ä»¶ï¼ŒReactor é€šè¿‡è°ƒåº¦é€‚å½“çš„å¤„ç†ç¨‹åºæ¥ç›¸åº” I/O äº‹ä»¶ï¼Œå¤„ç†ç¨‹åºä¼šæ‰§è¡Œéé˜»å¡æ“ä½œ</li></ul></li><li>ä¼˜ç‚¹ï¼š <ul><li>å“åº”å¿«ï¼Œä¸å¿…ä¸ºå•ä¸ªåŒæ­¥æ‰€é˜»å¡ï¼ˆè™½ç„¶ Reactor æœ¬èº«ä¾æ—§æ˜¯åŒæ­¥çš„ï¼‰</li><li>å¯ä»¥æœ€å¤§ç¨‹åº¦åœ°é¿å…å¤æ‚çš„å¤šçº¿ç¨‹ä»¥åŠåŒæ­¥é—®é¢˜ï¼Œå¹¶ä¸”é¿å…äº†å¤šçº¿ç¨‹/å¤šè¿›ç¨‹çš„åˆ‡æ¢å¼€é”€</li><li>æ‰©å±•æ€§å¥½ï¼Œå¯ä»¥æ–¹ä¾¿åœ°é€šè¿‡å¢åŠ  Reactor å®ä¾‹ä¸ªæ•°æ¥å……åˆ†åˆ©ç”¨ CPU èµ„æº</li><li>å¤ç”¨æ€§å¥½ï¼ŒReactor æ¨¡å‹æœ¬èº«ä¸å…·ä½“äº‹ä»¶å¤„ç†é€»è¾‘æ— å…³ï¼Œå…·æœ‰å¾ˆé«˜çš„å¤ç”¨æ€§</li></ul></li></ul><h3 id="å•çº¿ç¨‹æ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#å•çº¿ç¨‹æ¨¡å‹" aria-hidden="true">#</a> å•çº¿ç¨‹æ¨¡å‹</h3><figure><img src="https://my-photos-1.oss-cn-hangzhou.aliyuncs.com/markdown/https://my-photos-1.oss-cn-hangzhou.aliyuncs.com/markdown/https://my-photos-1.oss-cn-hangzhou.aliyuncs.com/markdown/https://my-photos-1.oss-cn-hangzhou.aliyuncs.com/markdown/https://my-photos-1.oss-cn-hangzhou.aliyuncs.com/markdown//netty/20230209/å•çº¿ç¨‹æ¨¡å‹.jpg" alt="ä»€ä¹ˆæ˜¯Nettyï¼Ÿ_æ…•è¯¾æ‰‹è®°" tabindex="0" loading="lazy"><figcaption>ä»€ä¹ˆæ˜¯Nettyï¼Ÿ_æ…•è¯¾æ‰‹è®°</figcaption></figure><ul><li><p>å¯ä»¥å®ç°åº”ç”¨ç¨‹åºé€šè¿‡ä¸€ä¸ªã€Œé˜»å¡å¯¹è±¡ã€ç›‘å¬ã€Œå¤šè·¯è¿æ¥è¯·æ±‚ã€</p></li><li><p>Reactor å¯¹è±¡é€šè¿‡ç›‘æ§å®¢æˆ·ç«¯è¯·æ±‚äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶è¿›è¡Œåˆ†å‘</p></li><li><p>å¦‚æœå»ºç«‹è¿æ¥è¯·æ±‚äº‹ä»¶ï¼Œåˆ™ç”± Acceptor å¯¹è±¡é€šè¿‡ Accept å¤„ç†è¿æ¥è¯·æ±‚ï¼Œç„¶ååˆ›å»ºä¸€ä¸ª Handler å¯¹è±¡å¤„ç†è¿ç»­å®Œæˆåçš„åç»­ä¸šåŠ¡å¤„ç†</p></li><li><p>å¦‚æœå»ºç«‹çš„ä¸æ˜¯è¿æ¥äº‹ä»¶ï¼Œåˆ™ Reactor ä¼šåˆ†å‘è°ƒç”¨è¿æ¥å¯¹åº”çš„ Handler æ¥å“åº”äº‹ä»¶</p></li><li><p>Handler ä¼šå®Œæˆ Read -&gt; ä¸šåŠ¡å¤„ç† -&gt; Send çš„å®Œæ•´ä¸šåŠ¡æµç¨‹</p></li><li><p>è¿™æ ·æœåŠ¡ç«¯å°±ç”¨ã€Œä¸€ä¸ªçº¿ç¨‹ã€é€šè¿‡å¤šè·¯å¤ç”¨å®Œæˆäº†æ‰€æœ‰çš„ I/O æ“ä½œï¼ˆåŒ…æ‹¬è¿æ¥ã€è¯»å†™ç­‰ï¼‰ï¼Œç¼–ç ç®€å•æ¸…æ™°ï¼Œä½†æ˜¯å¦‚æœå®¢æˆ·ç«¯è¿æ¥æ•°é‡æ¯”è¾ƒå¤šçš„è¯ï¼Œå°†æ— æ³•æ”¯æ’‘</p></li><li><p>ä¼˜ç‚¹ï¼šæ¨¡å‹ç®€å•ï¼Œæ²¡æœ‰å¤šçº¿ç¨‹ã€è¿›ç¨‹é€šä¿¡ã€ç«äº‰çš„é—®é¢˜ï¼Œå³å…¨éƒ¨éƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹å†…å®Œæˆ</p></li><li><p>ç¼ºç‚¹ï¼šå› ä¸ºåªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥ä¼šæœ‰æ€§èƒ½é—®é¢˜ï¼Œæ•´ä¸ªè¿›ç¨‹æ— æ³•å¤„ç†å…¶ä»–è¿æ¥äº‹ä»¶ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´æ€§èƒ½ç“¶é¢ˆï¼›è€Œä¸”çº¿ç¨‹å¦‚æœæ„å¤–ç»ˆæ­¢ï¼Œæˆ–è€…è¿›å…¥æ­»å¾ªç¯ï¼Œä¼šå¯¼è‡´æ•´ä¸ªç³»ç»Ÿé€šä¿¡æ¨¡å—ä¸å¯ç”¨ï¼Œä¸èƒ½æ¥æ”¶å’Œå¤„ç†å¤–éƒ¨æ¶ˆæ¯ï¼Œé€ æˆèŠ‚ç‚¹æ•…éšœï¼ˆå¯é æ€§é—®é¢˜ï¼‰</p></li><li><p>ä½¿ç”¨åœºæ™¯ï¼šå®¢æˆ·ç«¯çš„æ•°é‡æœ‰é™ï¼Œä¸šåŠ¡å¤„ç†éå¸¸å¿«çš„æƒ…å†µï¼Œæ¯”å¦‚ Redis åœ¨ä¸šåŠ¡å¤„ç†æ—¶é—´å¤æ‚åº¦ O(1) çš„æƒ…å†µ</p></li></ul><h3 id="å¤šçº¿ç¨‹æ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#å¤šçº¿ç¨‹æ¨¡å‹" aria-hidden="true">#</a> å¤šçº¿ç¨‹æ¨¡å‹</h3><figure><img src="https://my-photos-1.oss-cn-hangzhou.aliyuncs.com/markdown/https://my-photos-1.oss-cn-hangzhou.aliyuncs.com/markdown/https://my-photos-1.oss-cn-hangzhou.aliyuncs.com/markdown/https://my-photos-1.oss-cn-hangzhou.aliyuncs.com/markdown//netty/20230209/å¤šçº¿ç¨‹æ¨¡å‹.jpeg" alt="image-20230108113811182" tabindex="0" loading="lazy"><figcaption>image-20230108113811182</figcaption></figure><ul><li>Reactor å¯¹è±¡é€šè¿‡ select ç›‘æ§å®¢æˆ·ç«¯è¯·æ±‚äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åé€šè¿‡ dispatch è¿›è¡Œåˆ†å‘</li><li>å¦‚æœå»ºç«‹è¿æ¥è¯·æ±‚ï¼Œåˆ™ Acceptor å¯¹è±¡é€šè¿‡ Accept å¤„ç†è¿æ¥è¯·æ±‚ï¼Œç„¶ååˆ›å»ºä¸€ä¸ª Handler å¯¹è±¡å¤„ç†å®Œæˆè¿æ¥åçš„å„ä¸ªäº‹ä»¶</li><li>å¦‚æœä¸æ˜¯è¿æ¥è¯·æ±‚ï¼Œåˆ™ç”± Reactor åˆ†å‘è°ƒç”¨è¿æ¥å¯¹åº”çš„ Handler æ¥å¤„ç†</li><li>Handler åªè´Ÿè´£å“åº”äº‹ä»¶ï¼Œä¸åšå…·ä½“çš„ä¸šåŠ¡å¤„ç†ï¼Œé€šè¿‡ Read è¯»å–æ•°æ®åï¼Œä¼šåˆ†å‘ç»™åé¢çš„ Worker çº¿ç¨‹æ± çš„æŸä¸ªçº¿ç¨‹å¤„ç†ä¸šåŠ¡</li><li>Worker çº¿ç¨‹æ± ä¼šåˆ†é…ç‹¬ç«‹çš„çº¿ç¨‹å®ŒæˆçœŸæ­£çš„ä¸šåŠ¡ï¼Œå¹¶å°†ç»“æœè¿”å›ç»™ Handlerï¼ŒHandler æ”¶åˆ°å“åº”åï¼Œé€šè¿‡ Send å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯</li><li>ä¼˜ç‚¹ï¼šå¯ä»¥å……åˆ†åœ°åˆ©ç”¨å¤šæ ¸ CPU çš„å¤„ç†èƒ½åŠ›</li><li>ç¼ºç‚¹ï¼šå¤šçº¿ç¨‹ã€Œæ•°æ®å…±äº«ã€å’Œã€Œè®¿é—®ã€æ¯”è¾ƒå¤æ‚ï¼ŒReactor å¤„ç†æ‰€æœ‰çš„äº‹ä»¶çš„ã€Œç›‘å¬ã€å’Œã€Œå“åº”ã€ï¼ŒReactor åœ¨å•çº¿ç¨‹é«˜å¹¶å‘åœºæ™¯ä¸‹å®¹æ˜“å‡ºç°ç“¶é¢ˆ</li></ul><h3 id="ä¸»ä»-reactor-å¤šçº¿ç¨‹" tabindex="-1"><a class="header-anchor" href="#ä¸»ä»-reactor-å¤šçº¿ç¨‹" aria-hidden="true">#</a> ä¸»ä» Reactor å¤šçº¿ç¨‹</h3><img src="https://my-photos-1.oss-cn-hangzhou.aliyuncs.com/markdown/https://my-photos-1.oss-cn-hangzhou.aliyuncs.com/markdown/https://my-photos-1.oss-cn-hangzhou.aliyuncs.com/markdown//netty/20230209/ä¸»ä»Reactorå¤šçº¿ç¨‹.jpeg" alt="ä»€ä¹ˆæ˜¯Nettyï¼Ÿ_æ…•è¯¾æ‰‹è®°" style="zoom:50%;"><ul><li>SubReactor å¯ä»¥æœ‰å¤šä¸ªï¼Œå³ Reactor ä¸»çº¿ç¨‹å¯ä»¥å¯¹åº”å¤šä¸ª Reactor å­çº¿ç¨‹ï¼Œä»¥æ­¤è§£å†³ Reactor çš„æ€§èƒ½ç“¶é¢ˆ</li><li>MainReactor å¯¹è±¡é€šè¿‡ Select ç›‘å¬è¿æ¥äº‹ä»¶ï¼Œæ”¶åˆ°åé€šè¿‡ Acceptor å¯¹è±¡å¤„ç†è¿æ¥äº‹ä»¶</li><li>å½“ Acceptor å¯¹è±¡å¤„ç†è¿æ¥äº‹ä»¶åï¼ŒMainReactor ä¼šå°†è¿æ¥åˆ†å‘ç»™ SubReactor</li><li>SubReactor å°†è¿æ¥åŠ å…¥åˆ°è¿æ¥é˜Ÿåˆ—è¿›è¡Œç›‘å¬ï¼Œå¹¶åˆ›å»º Handler è¿›è¡Œå„ç§äº‹ä»¶çš„å¤„ç†</li><li>å½“æœ‰æ–°äº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒSubReactor å°±ä¼šè°ƒç”¨å¯¹åº”çš„ Handler å¤„ç†ï¼ŒHandler é€šè¿‡ Read è¯»å–æ•°æ®ï¼Œåˆ†å‘ç»™ä¹‹åçš„ Worker çº¿ç¨‹å¤„ç†</li><li>Worker çº¿ç¨‹æ± ä¼šåˆ†é…ç‹¬ç«‹çš„ Worker çº¿ç¨‹è¿›è¡Œä¸šåŠ¡å¤„ç†å¹¶è¿”å›ç»“æœ</li><li>Handler æ”¶åˆ°å“åº”ç»“æœåï¼Œå†é€šè¿‡ Send å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯</li><li>ä¼˜ç‚¹ï¼šçˆ¶çº¿ç¨‹ä¸å­çº¿ç¨‹çš„æ•°æ®äº¤äº’èŒè´£æ˜ç¡®ï¼Œçˆ¶çº¿ç¨‹åªéœ€è¦æ¥æ”¶æ–°è¿æ¥ï¼Œå­çº¿ç¨‹åˆ™å®Œæˆåç»­çš„ä¸šåŠ¡å¤„ç†ï¼›çˆ¶å­çº¿ç¨‹ä¹‹é—´çš„æ•°æ®äº¤äº’ä¹Ÿç®€å•ï¼ŒReactor ä¸»çº¿ç¨‹åªéœ€è¦æŠŠæ–°è¿æ¥ä¼ é€’ç»™å­çº¿ç¨‹å³å¯ï¼Œå­çº¿ç¨‹æ— éœ€è¿”å›æ•°æ®</li><li>ç¼ºç‚¹ï¼šç¼–ç¨‹å¤æ‚åº¦è¾ƒé«˜</li><li>è¯¥æ¨¡å‹å†è®¸å¤šé¡¹ç›®ä¸­éƒ½æœ‰åº”ç”¨ï¼Œæ¯”å¦‚ Nginx ä¸»ä» Reactor å¤šçº¿ç¨‹æ¨¡å‹ã€Memcahed ä¸»ä»å¤šçº¿ç¨‹ã€Netty ä¸»ä»å¤šçº¿ç¨‹</li></ul><h3 id="netty-ä¸»ä»å¤šçº¿ç¨‹" tabindex="-1"><a class="header-anchor" href="#netty-ä¸»ä»å¤šçº¿ç¨‹" aria-hidden="true">#</a> Netty ä¸»ä»å¤šçº¿ç¨‹</h3><figure><img src="https://my-photos-1.oss-cn-hangzhou.aliyuncs.com/markdown/https://my-photos-1.oss-cn-hangzhou.aliyuncs.com/markdown//netty/20230209/ä¸»ä»å¤šçº¿ç¨‹.jpeg" alt="ä½¿ç”¨nettyæ‰‹æ’¸ä¸€ä¸ªç®€æ˜“httpæœåŠ¡å™¨" tabindex="0" loading="lazy"><figcaption>ä½¿ç”¨nettyæ‰‹æ’¸ä¸€ä¸ªç®€æ˜“httpæœåŠ¡å™¨</figcaption></figure><ul><li>BossGroup çº¿ç¨‹ç»´æŠ¤ Selectorï¼Œåªå…³æ³¨ Acceptï¼Œæ¥æ”¶åˆ° Accept äº‹ä»¶åï¼Œä¼šè·å–å¯¹åº”çš„ SocketChannelï¼Œå°è£…æˆ NIOSocketChannel æ³¨å†Œåˆ° Worker çº¿ç¨‹ï¼ˆäº‹ä»¶å¾ªç¯ï¼‰å¹¶è¿›è¡Œç»´æŠ¤</li><li>å½“ Worker çº¿ç¨‹ç›‘å¬åˆ° Selector ä¸­é€šé“å‘ç”Ÿäº† Worker å…³å¿ƒçš„äº‹ä»¶æ—¶ï¼Œå°±ä¼šè¿›è¡Œå¤„ç†ï¼ˆç”± Handler å¤„ç†ï¼Œè¿™é‡Œçš„ Handler å·²ç»åŠ å…¥åˆ°é€šé“äº†ï¼‰</li><li>BossGroup ç›¸å½“äº MainReactorï¼Œä¸“é—¨å¤æ‚æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œè€Œ WorkerGroup ç›¸å½“äº SubReactorGroupï¼Œä¸“é—¨å¤æ‚ç½‘ç»œçš„è¯»å†™ï¼ŒäºŒè€…çš„äº‹ä»¶å¾ªç¯ï¼ˆNioEventLoopï¼‰å¯ä»¥æœ‰å¤šä¸ªï¼Œä»¥æ­¤æ„æˆ NioEventGroup</li><li>NioEventLoop è¡¨ç¤ºä¸€ä¸ªä¸æ–­å¾ªç¯çš„æ‰§è¡Œå¤„ç†ä»»åŠ¡çš„çº¿ç¨‹ï¼Œæ¯ä¸ª NioEventLoop éƒ½æœ‰ä¸€ä¸ª Selectorï¼Œç”¨äºç›‘å¬ç»‘å®šåœ¨å…¶ä¸Šçš„ Socket ç½‘ç»œé€šè®¯</li><li>æ¯ä¸ª Boss NioEventLoop æ‰§è¡Œçš„æ­¥éª¤æœ‰ï¼š <ul><li>è½®è¯¢ Accept äº‹ä»¶</li><li>å¤„ç† Accept äº‹ä»¶ï¼Œä¸å®¢æˆ·ç«¯å»ºç«‹è¿æ¥ï¼Œç”Ÿæˆ NioSocketChannelï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ°æŸä¸ª Worker NioEventLoop ä¸Šçš„ Selector</li><li>å¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œå³ runAllTasks</li></ul></li><li>æ¯ä¸ª Worker NioEventLoop æ‰§è¡Œçš„æ­¥éª¤æœ‰ï¼š <ul><li>è½®è¯¢ Readã€Write äº‹ä»¶</li><li>å¤„ç† I/O äº‹ä»¶ï¼Œå³è¯»å†™äº‹ä»¶ï¼Œåœ¨å¯¹åº”çš„ NioSocketChannel ä¸­å¤„ç†</li><li>å¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œå³ runAllTasks</li></ul></li><li>æ¯ä¸ª Worker NioEventLoop å¤„ç†ä¸šåŠ¡æ—¶ï¼Œä¼šä½¿ç”¨ Pipelineï¼ˆç®¡é“ï¼‰ï¼Œå…¶ä¸­åŒ…å«äº† Channelï¼Œå³é€šè¿‡ Pipeline å¯ä»¥è·å¾—å¯¹åº”çš„ç®¡é“ï¼Œç®¡é“ä¸­ç»´æŠ¤äº†å¾ˆå¤šçš„ Handler</li><li>NioEventLoop å†…éƒ¨é‡‡ç”¨ã€Œä¸²è¡ŒåŒ–ã€è®¾è®¡ï¼Œæ¶ˆæ¯çš„è¯»å–ã€è§£ç ã€å¤„ç†ã€ç¼–ç ã€å‘é€ï¼Œå§‹ç»ˆéƒ½ç”± I/O çº¿ç¨‹ NioEventLoop è´Ÿè´£</li><li>æ¯ä¸ª NioEventLoop éƒ½åŒ…å«ä¸€ä¸ª Selector å’Œä¸€ä¸ª TaskQueueï¼ŒSelector ä¸Šå¯ä»¥æ³¨å†Œç›‘å¬å¤šä¸ª NioChannelï¼Œæ¯ä¸ª NioChannel åªä¼šç»‘å®šåœ¨å”¯ä¸€çš„ NioEventLoop ä¸Šï¼Œè€Œä¸”æ¯ä¸ª NioChannel éƒ½ç»‘å®šæœ‰ä¸€ä¸ª ChannelPipeline</li></ul><h2 id="netty-ç®€å•ä½¿ç”¨-1" tabindex="-1"><a class="header-anchor" href="#netty-ç®€å•ä½¿ç”¨-1" aria-hidden="true">#</a> Netty ç®€å•ä½¿ç”¨</h2><p><strong>æœåŠ¡ç«¯ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyServer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ç»„ï¼ˆä¸¤ä¸ªåº•å±‚éƒ½æ˜¯æ— é™å¾ªç¯ï¼‰</span>
        <span class="token comment">// åŒ…å«çš„å­çº¿ç¨‹æ•°ä¸ºï¼šCPU æ ¸æ•° * 2</span>
        <span class="token class-name">NioEventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">NioEventLoopGroup</span> workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// åˆ›å»ºæœåŠ¡å™¨ç«¯çš„å¯åŠ¨å¯¹è±¡ï¼Œé…ç½®å‚æ•°</span>
            <span class="token class-name">ServerBootstrap</span> bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// é“¾å¼ç¼–ç¨‹é…ç½®</span>
            bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
                    <span class="token comment">// ä½¿ç”¨ NioServerSocketChannel ä½œä¸ºæœåŠ¡å™¨çš„é€šé“å®ç°</span>
                    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                    <span class="token comment">// çº¿ç¨‹é˜Ÿåˆ—çš„è¿æ¥ä¸ªæ•°</span>
                    <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_BACKLOG</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>
                    <span class="token comment">// ä¿æŒè¿æ¥çŠ¶æ€</span>
                    <span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_KEEPALIVE</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
                    <span class="token comment">// è®¾ç½® workerGroup çš„ EventGroup å¯¹åº”çš„ç®¡é“çš„å¤„ç†å™¨</span>
                    <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// ç»™ Pipeline è®¾ç½®å¤„ç†å™¨</span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> socketChannel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                            socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NettyServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡å™¨å‡†å¤‡å°±ç»ª...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ç»‘å®šä¸€ä¸ªç«¯å£å¹¶åŒæ­¥ï¼Œç”Ÿæˆä¸€ä¸ª ChannelFuture å¯¹è±¡</span>
            <span class="token class-name">ChannelFuture</span> cf <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token number">6668</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å¯¹å…³é—­é€šé“è¿›è¡Œç›‘å¬</span>
            cf<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            bossGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            workerGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å®¢æˆ·ç«¯ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyClient</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// å®¢æˆ·ç«¯åªéœ€è¦ä¸€ä¸ªäº‹ä»¶å¾ªç¯ç»„</span>
        <span class="token class-name">EventLoopGroup</span> eventExecutors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// åˆ›å»ºå®¢æˆ·ç«¯çš„å¯åŠ¨å¯¹è±¡ï¼ˆä¸æ˜¯ ServerBootstrapï¼‰</span>
            <span class="token class-name">Bootstrap</span> bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è®¾ç½®ç›¸å…³å‚æ•°</span>
            bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>eventExecutors<span class="token punctuation">)</span>
                    <span class="token comment">// è®¾ç½®å®¢æˆ·ç«¯é€šé“çš„å®ç°</span>
                    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                    <span class="token comment">// è®¾ç½®å¤„ç†å™¨</span>
                    <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> socketChannel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                            socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NettyClientHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å®¢æˆ·ç«¯å‡†å¤‡å°±ç»ª...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å¯åŠ¨å®¢æˆ·ç«¯ï¼Œè¿æ¥æœåŠ¡ç«¯</span>
            <span class="token class-name">ChannelFuture</span> channelFuture <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">6668</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ç»™å…³é—­é€šé“è¿›è¡Œç›‘å¬</span>
            channelFuture<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            eventExecutors<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æœåŠ¡ç«¯çš„å¤„ç†å™¨ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * è‡ªå®šä¹‰å¤„ç†å™¨ï¼Œéœ€è¦éµå®ˆ Netty çš„è§„èŒƒï¼ˆChannelInboundHandlerAdapterï¼‰
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     *
     * <span class="token keyword">@param</span> <span class="token parameter">ctx</span> ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå«æœ‰ pipeline
     * <span class="token keyword">@param</span> <span class="token parameter">msg</span> å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼Œé»˜è®¤æ˜¯ Object
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Server Context: &quot;</span> <span class="token operator">+</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å°† msg è½¬æˆä¸€ä¸ªç¼“å†²åŒºï¼ˆnetty æä¾›çš„æ€§èƒ½æ›´é«˜çš„ç¼“å†²åŒºï¼‰</span>
        <span class="token class-name">ByteBuf</span> buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯æ˜¯: &quot;</span> <span class="token operator">+</span> buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å®¢æˆ·ç«¯åœ°å€: &quot;</span> <span class="token operator">+</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token doc-comment comment">/**
     * æ•°æ®è¯»å–å®Œæ¯•ååšçš„å¤„ç†
     * <span class="token keyword">@param</span> <span class="token parameter">ctx</span> ä¸Šä¸‹æ–‡å¯¹è±¡
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelReadComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// å°†æ•°æ®å†™å…¥ç¼“å†²åŒºå¹¶åˆ·æ–°ï¼Œä¿¡æ¯éœ€è¦è¿›è¡Œç¼–ç </span>
        ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token class-name">Unpooled</span><span class="token punctuation">.</span><span class="token function">copiedBuffer</span><span class="token punctuation">(</span><span class="token string">&quot;Hello world&quot;</span><span class="token punctuation">,</span> <span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token doc-comment comment">/**
     * å¤„ç†å¼‚å¸¸ï¼Œä¸€èˆ¬æ˜¯éœ€è¦å…³é—­é€šé“
     * <span class="token keyword">@param</span> <span class="token parameter">ctx</span> ä¸Šä¸‹æ–‡å¯¹è±¡
     * <span class="token keyword">@param</span> <span class="token parameter">cause</span> å¼‚å¸¸
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å®¢æˆ·ç«¯çš„å¤„ç†å™¨ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyClientHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * å½“é€šé“å°±ç»ªå°±ä¼šè§¦å‘è¿™ä¸ªæ–¹æ³•
     * <span class="token keyword">@param</span> <span class="token parameter">ctx</span> ä¸Šä¸‹æ–‡å¯¹è±¡
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Client Context: &quot;</span> <span class="token operator">+</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token class-name">Unpooled</span><span class="token punctuation">.</span><span class="token function">copiedBuffer</span><span class="token punctuation">(</span><span class="token string">&quot;Hello Server&quot;</span><span class="token punctuation">,</span> <span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token doc-comment comment">/**
     * å½“é€šé“æœ‰è¯»å–äº‹ä»¶æ—¶å°±ä¼šè§¦å‘è¿™ä¸ªæ–¹æ³•
     * <span class="token keyword">@param</span> <span class="token parameter">ctx</span> ä¸Šä¸‹æ–‡å¯¹è±¡
     * <span class="token keyword">@param</span> <span class="token parameter">msg</span> æœåŠ¡ç«¯å‘é€çš„æ¶ˆæ¯
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ByteBuf</span> byteBuf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡å™¨å›å¤çš„æ¶ˆæ¯: &quot;</span> <span class="token operator">+</span> byteBuf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡å™¨çš„åœ°å€: &quot;</span> <span class="token operator">+</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token doc-comment comment">/**
     * å¤„ç†å¼‚å¸¸ï¼Œä¸€èˆ¬æ˜¯å…³é—­ç®¡é“
     * <span class="token keyword">@param</span> <span class="token parameter">ctx</span> ä¸Šä¸‹æ–‡å¯¹è±¡
     * <span class="token keyword">@param</span> <span class="token parameter">cause</span> å¼‚å¸¸
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        cause<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="netty-æ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#netty-æ¨¡å‹" aria-hidden="true">#</a> Netty æ¨¡å‹</h1><h2 id="netty-ä»»åŠ¡é˜Ÿåˆ—" tabindex="-1"><a class="header-anchor" href="#netty-ä»»åŠ¡é˜Ÿåˆ—" aria-hidden="true">#</a> Netty ä»»åŠ¡é˜Ÿåˆ—</h2><ul><li>å½“éœ€è¦å¤„ç†çš„ä¸šåŠ¡éå¸¸è€—æ—¶æ—¶å°±å¯ä»¥å°†å…¶æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¦åˆ™ä¼šé˜»å¡çº¿ç¨‹</li><li>ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ Task æœ‰ä¸‰ç§å…¸å‹ä½¿ç”¨åœºæ™¯ï¼š <ul><li>ç”¨æˆ·ç¨‹åºè‡ªå®šä¹‰çš„æ™®é€šä»»åŠ¡ï¼ˆä¼šæäº¤åˆ° TaskQueueï¼‰</li><li>ç”¨æˆ·è‡ªå®šä¹‰çš„å®šæ—¶ä»»åŠ¡ï¼ˆä¼šæäº¤åˆ° ScheduleTaskQueueï¼‰</li><li>éå½“å‰ Reactor çº¿ç¨‹è°ƒç”¨ Channel çš„å„ç§æ–¹æ³•</li></ul></li></ul><h2 id="å¼‚æ­¥æ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#å¼‚æ­¥æ¨¡å‹" aria-hidden="true">#</a> å¼‚æ­¥æ¨¡å‹</h2><ul><li>å½“ä¸€ä¸ªå¼‚æ­¥è¿‡ç¨‹è°ƒç”¨å‘å‡ºåï¼Œè°ƒç”¨è€…ä¸ä¼šç«‹å³å¾—åˆ°ç»“æœï¼Œå®é™…å¤„ç†è¿™ä¸ªè°ƒç”¨çš„ç»„ä»¶åœ¨å®Œæˆåï¼Œä¼šé€šè¿‡çŠ¶æ€ã€é€šçŸ¥å’Œå›è°ƒæ¥é€šçŸ¥è°ƒç”¨è€…</li><li>Netty ä¸­çš„ I/O æ“ä½œæ˜¯å¼‚æ­¥çš„ï¼ŒåŒ…æ‹¬ bindã€writeã€connect ç­‰æ“ä½œéƒ½ä¼šç®€å•åœ°è¿”å›ä¸€ä¸ª ChannelFuture</li><li>å¼‚æ­¥æ¨¡å‹ä¸‹ï¼Œè°ƒç”¨è€…ä¸èƒ½ç«‹å³è·å¾—ç»“æœï¼Œä½†æ˜¯ä¹‹åå¯ä»¥é€šè¿‡ Future-Listener æœºåˆ¶æ¥ä¸»åŠ¨è·å–æˆ–è€…é€šè¿‡é€šçŸ¥æœºåˆ¶è·å¾— I/O æ“ä½œç»“æœ</li><li>Netty çš„å¼‚æ­¥æ¨¡å‹æ˜¯å»ºç«‹åœ¨ Future å’Œ Callback ä¸Šçš„ï¼Œã€Œæ‹¦æˆªæ“ä½œã€å’Œã€Œè½¬æ¢å‡ºå…¥æ ˆæ•°æ®ã€åªéœ€è¦ç”¨æˆ·æä¾› Future æˆ–è€… Callback å³å¯ï¼Œè¿™æ ·å¯ä»¥è®©ã€Œä¸šåŠ¡é€»è¾‘ã€ä»ç½‘ç»œåŸºç¡€åº”ç”¨ç¼–ç ä¸­åˆ†ç¦»å‡ºæ¥ï¼ˆä¸ä¸šåŠ¡è§£è€¦ï¼Œä¹Ÿæ˜¯ Netty çš„è®¾è®¡ç›®æ ‡ï¼‰</li></ul><h3 id="future-listener-æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#future-listener-æœºåˆ¶" aria-hidden="true">#</a> Future-Listener æœºåˆ¶</h3><ul><li>å½“ Future å¯¹è±¡åˆšåˆ›å»ºæ—¶ï¼Œå¤„äºéå®ŒæˆçŠ¶æ€ï¼Œè°ƒç”¨è€…å¯ä»¥é€šè¿‡è¿”å›çš„ ChannelFuture æ¥è·å–æ“ä½œæ‰§è¡Œçš„çŠ¶æ€ï¼Œæ³¨å†Œç›‘å¬å‡½æ•°æ¥æ‰§è¡Œå®Œæˆåçš„æ“ä½œ</li><li>å¸¸è§çš„æ“ä½œæœ‰ï¼š <ul><li>é€šè¿‡æ–¹æ³• <code>isDone()</code> æ¥åˆ¤æ–­å½“å‰æ“ä½œæ˜¯å¦ã€Œå®Œæˆã€</li><li>é€šè¿‡æ–¹æ³• <code>isSuccess()</code> æ¥åˆ¤æ–­å·²å®Œæˆçš„æ“ä½œæ˜¯å¦ã€ŒæˆåŠŸã€</li><li>é€šè¿‡æ–¹æ³• <code>getCause()</code> æ¥åˆ¤æ–­å·²å®Œæˆçš„æ“ä½œçš„ã€Œå¤±è´¥åŸå› ã€</li><li>é€šè¿‡æ–¹æ³• <code>isCancelled()</code> æ¥åˆ¤æ–­å·²å®Œæˆçš„æ“ä½œæ˜¯å¦ã€Œè¢«å–æ¶ˆã€</li><li>é€šè¿‡æ–¹æ³• <code>addListener()</code> æ–¹æ³•æ¥æ³¨å†Œç›‘å¬å™¨ï¼Œå½“æ“ä½œå·²å®Œæˆï¼Œå°†ä¼šé€šçŸ¥æŒ‡å®šçš„ç›‘å¬å™¨</li></ul></li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ChannelFuture</span> cf <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token number">6668</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ç»™ cf æ³¨å†Œç›‘å¬å™¨ï¼Œç›‘å¬å…³å¿ƒçš„äº‹ä»¶</span>
cf<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelFutureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelFuture</span> channelFuture<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>channelFuture<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ç›‘å¬ç«¯å£æˆåŠŸï¼&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ç›‘å¬ç«¯å£å¤±è´¥ï¼&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ç®€å•çš„-http-æœåŠ¡" tabindex="-1"><a class="header-anchor" href="#ç®€å•çš„-http-æœåŠ¡" aria-hidden="true">#</a> ç®€å•çš„ HTTP æœåŠ¡</h2><p><strong>æœåŠ¡ç«¯ï¼ˆå®¢æˆ·ç«¯æ˜¯æµè§ˆå™¨ï¼‰ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestServer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">NioEventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">NioEventLoopGroup</span> workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerBootstrap</span> bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// é“¾å¼ç¼–ç¨‹é…ç½®</span>
            bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
                    <span class="token comment">// ä½¿ç”¨ NioServerSocketChannel ä½œä¸ºæœåŠ¡å™¨çš„é€šé“å®ç°</span>
                    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                    <span class="token comment">// è®¾ç½® workerGroup çš„ EventGroup å¯¹åº”çš„ç®¡é“çš„å¤„ç†å™¨</span>
                    <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TestServerInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡å™¨é…ç½®å®Œæˆ...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ChannelFuture</span> channelFuture <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token number">8881</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            channelFuture<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            bossGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            workerGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ç®¡é“åˆå§‹åŒ–ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestServerInitializer</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> socketChannel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// å‘ç®¡é“åŠ å…¥å¤„ç†å™¨</span>
        <span class="token comment">// è·å–ç®¡é“</span>
        <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åŠ å…¥ä¸€ä¸ª Netty æä¾›çš„ HTTP ç¼–è§£ç å™¨</span>
        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;HttpServerCodec&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HttpServerCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å¢åŠ ä¸€ä¸ªå¤„ç†å™¨</span>
        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;TestHttpServerHandler&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TestHttpServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>è‡ªå®šä¹‰å¤„ç†å™¨ï¼Œå‘æµè§ˆå™¨è¿”å›ä¸€æ®µè¯ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestHttpServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">SimpleChannelInboundHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpObject</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * è¯»å–å®¢æˆ·ç«¯æ•°æ®
     * <span class="token keyword">@param</span> <span class="token parameter">ctx</span> ä¸Šä¸‹æ–‡å¯¹è±¡
     * <span class="token keyword">@param</span> <span class="token parameter">msg</span> å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç›¸äº’é€šè®¯çš„æ•°æ®è¢«å°è£…æˆäº†è¯¥å¯¹è±¡
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">HttpObject</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;msg ç±»å‹: &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å®¢æˆ·ç«¯åœ°å€: &quot;</span> <span class="token operator">+</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å›å¤æ¶ˆæ¯ç»™æµè§ˆå™¨</span>
            <span class="token class-name">ByteBuf</span> context <span class="token operator">=</span> <span class="token class-name">Unpooled</span><span class="token punctuation">.</span><span class="token function">copiedBuffer</span><span class="token punctuation">(</span><span class="token string">&quot;Hello æˆ‘æ˜¯æœåŠ¡å™¨&quot;</span><span class="token punctuation">,</span> <span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ„é€ ä¸€ä¸ª HTTP Response</span>
            <span class="token class-name">DefaultFullHttpResponse</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultFullHttpResponse</span><span class="token punctuation">(</span><span class="token class-name">HttpVersion</span><span class="token punctuation">.</span><span class="token constant">HTTP_1_1</span><span class="token punctuation">,</span> <span class="token class-name">HttpResponseStatus</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaderNames</span><span class="token punctuation">.</span><span class="token constant">CONTENT_TYPE</span><span class="token punctuation">,</span> <span class="token string">&quot;text/plain&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaderNames</span><span class="token punctuation">.</span><span class="token constant">CONTENT_LENGTH</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="pipeline-ä¸-channel" tabindex="-1"><a class="header-anchor" href="#pipeline-ä¸-channel" aria-hidden="true">#</a> Pipeline ä¸ Channel</h2><figure><img src="https://my-photos-1.oss-cn-hangzhou.aliyuncs.com/markdown//netty/20230209/Pipelineä¸Channel.png" alt="image-20230108195118087" tabindex="0" loading="lazy"><figcaption>image-20230108195118087</figcaption></figure><ul><li>æ¯ä¸ª Channel éƒ½æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª ChannelPipeline ä¸ä¹‹å¯¹åº”</li><li>ChannelPipeline ä¸­ç»´æŠ¤äº†ä¸€ä¸ªç”± ChannelHandlerContext ç»„æˆçš„åŒå‘é“¾è¡¨ï¼Œå¹¶ä¸”æ¯ä¸ª ChannelHandlerContext ä¸­åˆå…³è”ç€ä¸€ä¸ª ChannelHandler</li><li>å…¥æ ˆäº‹ä»¶å’Œå‡ºæ ˆäº‹ä»¶å‡åœ¨ä¸€ä¸ªåŒå‘é“¾è¡¨ä¸­ï¼Œå…¥æ ˆäº‹ä»¶ä¼šä»é“¾è¡¨å¤´ç½‘åä¼ é€’åˆ°æœ€åä¸€ä¸ªå…¥æ ˆçš„ Handlerï¼Œå‡ºæ ˆäº‹ä»¶ç›¸åï¼Œä¸¤ç§ç±»å‹çš„ Handler äº’ä¸å¹²æ‰°</li><li>ChannelHandlerContext ä¿å­˜äº† Channel ç›¸å…³çš„æ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ŒChannelHandler æ˜¯å…¶ä¸­åŒ…å«çš„ä¸€ä¸ªå…·ä½“çš„äº‹ä»¶å¤„ç†å™¨ï¼ŒåŒæ—¶ ChannelHandlerContext ä¸­ä¹Ÿç»‘å®šäº†å¯¹åº”çš„ Pipeline å’Œ Channel çš„ä¿¡æ¯ï¼Œæ–¹ä¾¿ ChannelHandler è¿›è¡Œè°ƒç”¨</li><li>ChannelHandlerContext ä¸­å¸¸ç”¨çš„æ–¹æ³•æœ‰ï¼š<code>close()</code> å…³é—­é€šé“ã€<code>flush()</code> åˆ·æ–°ã€<code>writeAndFlush()</code> å†™æ•°æ®åˆ° ChannelPipeline ä¸­</li></ul><h2 id="eventloopgroup" tabindex="-1"><a class="header-anchor" href="#eventloopgroup" aria-hidden="true">#</a> EventLoopGroup</h2><ul><li>EventLoopGroup æ˜¯ä¸€ç»„ EventLoop çš„æŠ½è±¡ï¼ŒNetty ä¸ºäº†æ›´å¥½åœ°åˆ©ç”¨å¤šæ ¸ CPU çš„èµ„æºï¼Œä¸€èˆ¬ä¼šæœ‰å¤šä¸ª EventLoop åŒæ—¶å·¥ä½œï¼Œæ¯ä¸ª EventLoop ç»´æŠ¤ç€ä¸€ä¸ª Selector å®ä¾‹</li><li>EventLoopGroup æä¾› <code>next</code> æ¥å£ï¼Œå¯ä»¥ä» Group ä¸­æŒ‰ç…§ä¸€å®šè§„åˆ™è·å–å…¶ä¸­ä¸€ä¸ª EventLoop æ¥å¤„ç†ä»»åŠ¡ï¼Œåœ¨ Netty ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½éœ€è¦æä¾›ä¸¤ä¸ª EventLoopGroupï¼Œå³ BossEventLoopGroup å’Œ WorkerEventLoopGroup</li><li>é€šå¸¸ä¸€ä¸ªæœåŠ¡ç«¯å£ï¼Œå³ä¸€ä¸ª ServerSocketChannel å¯¹åº”ä¸€ä¸ª Selector å’Œä¸€ä¸ª EventLoop çº¿ç¨‹ï¼›BossEventLoopGroup è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥å¹¶å°† SocketChannel äº¤ç»™ WorkerEventLoopGroup æ¥è¿›è¡Œ I/O å¤„ç†</li><li>ä¸€èˆ¬æ¥è¯´ï¼ŒBossEventLoopGroup æ˜¯å•çº¿ç¨‹ï¼Œè€Œ WorkerEventLoopGroup é»˜è®¤æ˜¯ CPU æ ¸æ•° * 2</li></ul><h2 id="netty-å¿ƒè·³æ£€æµ‹" tabindex="-1"><a class="header-anchor" href="#netty-å¿ƒè·³æ£€æµ‹" aria-hidden="true">#</a> Netty å¿ƒè·³æ£€æµ‹</h2><p><strong>æœåŠ¡ç«¯ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Server</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">EventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EventLoopGroup</span> workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerBootstrap</span> serverBootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            serverBootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                    <span class="token comment">// æ—¥å¿—å¤„ç†å™¨</span>
                    <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span><span class="token class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">INFO</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> socketChannel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                            <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token doc-comment comment">/**
                             * Netty æä¾›çš„å¤„ç†ç©ºé—²çŠ¶æ€çš„å¤„ç†å™¨
                             * ä¸‰ä¸ªå‚æ•°çš„å«ä¹‰åˆ†åˆ«ä¸ºï¼š
                             * 1.å¤šé•¿æ—¶é—´æ²¡æœ‰è¯»æ“ä½œåï¼Œä¼šå‘é€ä¸€ä¸ªå¿ƒè·³æ£€æµ‹åŒ…æ£€æµ‹æ˜¯å¦è¿æ¥
                             * 2.å¤šé•¿æ—¶é—´æ²¡æœ‰å†™æ“ä½œåï¼Œä¼šå‘é€ä¸€ä¸ªå¿ƒè·³æ£€æµ‹åŒ…æ£€æµ‹æ˜¯å¦è¿æ¥
                             * 1.å¤šé•¿æ—¶é—´æ²¡æœ‰è¯»å†™æ“ä½œåï¼Œä¼šå‘é€ä¸€ä¸ªå¿ƒè·³æ£€æµ‹åŒ…æ£€æµ‹æ˜¯å¦è¿æ¥
                             */</span>
                            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IdleStateHandler</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// å½“ IdleStateHandler è§¦å‘åï¼Œä¼šä¼ é€’ç»™ç®¡é“çš„ä¸‹ä¸€å¤„ç†å™¨çš„ userEventTriggered æ–¹æ³•å¤„ç†</span>
                            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡å™¨å‡†å¤‡å°±ç»ª...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ChannelFuture</span> channelFuture <span class="token operator">=</span> serverBootstrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token number">7500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            channelFuture<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            bossGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            workerGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å¤„ç†å™¨ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">userEventTriggered</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> evt<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>evt <span class="token keyword">instanceof</span> <span class="token class-name">IdleStateEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">IdleStateEvent</span> event <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IdleStateEvent</span><span class="token punctuation">)</span> evt<span class="token punctuation">;</span>
            <span class="token class-name">String</span> eventType <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token constant">READER_IDLE</span><span class="token operator">:</span>
                    eventType <span class="token operator">=</span> <span class="token string">&quot;è¯»ç©ºé—²&quot;</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token constant">WRITER_IDLE</span><span class="token operator">:</span>
                    eventType <span class="token operator">=</span> <span class="token string">&quot;å†™ç©ºé—²&quot;</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token constant">ALL_IDLE</span><span class="token operator">:</span>
                    eventType <span class="token operator">=</span> <span class="token string">&quot;è¯»å†™ç©ºé—²&quot;</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; è¶…æ—¶æ—¶é—´å‘ç”Ÿ: &quot;</span> <span class="token operator">+</span> eventType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="netty-websocket-é•¿è¿æ¥" tabindex="-1"><a class="header-anchor" href="#netty-websocket-é•¿è¿æ¥" aria-hidden="true">#</a> Netty WebSocket é•¿è¿æ¥</h2><p><strong>æœåŠ¡ç«¯ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Server</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">EventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EventLoopGroup</span> workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerBootstrap</span> serverBootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            serverBootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                    <span class="token comment">// æ—¥å¿—å¤„ç†å™¨</span>
                    <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span><span class="token class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">INFO</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> socketChannel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                            <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// åŸºäº HTTP åè®®ï¼Œä½¿ç”¨ HTTP çš„ç¼–è§£ç å™¨</span>
                            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpServerCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// ä»¥å—æ–¹å¼å†™ï¼Œæ·»åŠ  ChunkedWriteHandler å¤„ç†å™¨</span>
                            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChunkedWriteHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token doc-comment comment">/**
                             * HTTP æ•°æ®ä¼ è¾“è¿‡ç¨‹æ˜¯åˆ†æ®µçš„ï¼Œå¯ä»¥é€šè¿‡ HttpObjectAggregator å°†å¤šä¸ªæ®µèšåˆ
                             * è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå‘é€å¤§é‡æ•°æ®æ—¶æµè§ˆå™¨éœ€è¦å‘å‡ºå¤šä¸ª HTTP è¯·æ±‚
                             */</span>
                            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpObjectAggregator</span><span class="token punctuation">(</span><span class="token number">8192</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token doc-comment comment">/**
                             * å¯¹åº” WebSocketï¼Œæ•°æ®ä»¥æ•°æ®å¸§çš„å½¢å¼ä¼ é€’
                             * WebSocketFrame ä¸‹æœ‰å…­ä¸ªå­ç±»
                             * æµè§ˆå™¨è¯·æ±‚æ—¶ï¼Œä½¿ç”¨çš„åè®®æ˜¯ WebSocketï¼Œå½¢å¼ä¸ºï¼šws://localhost:xxx/xxx
                             * WebSocketServerProtocolHandler çš„åŠŸèƒ½æ˜¯å°† HTTP åè®®å‡çº§æˆ WebSocket åè®®ï¼Œä»¥æ­¤ä¿æŒé•¿è¿æ¥
                             */</span>
                            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebSocketServerProtocolHandler</span><span class="token punctuation">(</span><span class="token string">&quot;/hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// è‡ªå®šä¹‰å¤„ç†å™¨å¤„ç†ä¸šåŠ¡é€»è¾‘</span>
                            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebSocketServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡å™¨å‡†å¤‡å°±ç»ª...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ChannelFuture</span> channelFuture <span class="token operator">=</span> serverBootstrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token number">7500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            channelFuture<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            bossGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            workerGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æœåŠ¡ç«¯å¤„ç†å™¨ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSocketServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">SimpleChannelInboundHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TextWebSocketFrame</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">TextWebSocketFrame</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡å™¨æ”¶åˆ°æ¶ˆæ¯: &quot;</span>  <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å›å¤æ¶ˆæ¯</span>
        ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextWebSocketFrame</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡å™¨å½“å‰æ—¶é—´: &quot;</span> <span class="token operator">+</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handlerAdded</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// id è¡¨ç¤ºå”¯ä¸€çš„å€¼ï¼ŒLongText æ˜¯å”¯ä¸€çš„ï¼ŒShortText ä¸æ˜¯å”¯ä¸€çš„</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;handlerAdded è¢«è°ƒç”¨ &quot;</span> <span class="token operator">+</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asLongText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handlerRemoved</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;handlerRemoved è¢«è°ƒç”¨ &quot;</span> <span class="token operator">+</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asLongText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å‘ç”Ÿå¼‚å¸¸: &quot;</span> <span class="token operator">+</span> cause<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å®¢æˆ·ç«¯ï¼Œæµè§ˆå™¨é¡µé¢ï¼š</strong></p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
        <span class="token keyword">var</span> socket<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>WebSocket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">&quot;ws://localhost:7500/hello&quot;</span><span class="token punctuation">)</span>
            socket<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> rt <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;response&#39;</span><span class="token punctuation">)</span>
                rt<span class="token punctuation">.</span>value <span class="token operator">=</span> rt<span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span> <span class="token operator">+</span> ev<span class="token punctuation">.</span>data
            <span class="token punctuation">}</span>
            socket<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> rt <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;response&#39;</span><span class="token punctuation">)</span>
                rt<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">&#39;è¿æ¥å¼€å¯...&#39;</span>
            <span class="token punctuation">}</span>
            socket<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> rt <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;response&#39;</span><span class="token punctuation">)</span>
                rt<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">&#39;è¿æ¥æ–­å¼€...&#39;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&#39;ä¸æ”¯æŒ WebSocket&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">function</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>socket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>socket<span class="token punctuation">.</span>readyState <span class="token operator">===</span> WebSocket<span class="token punctuation">.</span><span class="token constant">OPEN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&#39;è¿æ¥æœªå¼€å¯...&#39;</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token special-attr"><span class="token attr-name">onsubmit</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token value javascript language-javascript"><span class="token keyword">return</span></span></span></span> <span class="token attr-name">false</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>message<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">height</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> 300px</span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>å‘é€<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value javascript language-javascript"><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>form<span class="token punctuation">.</span>message<span class="token punctuation">.</span>value<span class="token punctuation">)</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>response<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">height</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> 300px</span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>æ¸…ç©º<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value javascript language-javascript">document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;response&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">&#39;&#39;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="protobuf-ç¼–è§£ç å™¨" tabindex="-1"><a class="header-anchor" href="#protobuf-ç¼–è§£ç å™¨" aria-hidden="true">#</a> Protobuf ç¼–è§£ç å™¨</h2><ul><li>ç½‘ç»œåº”ç”¨ç¨‹åºä¼ è¾“çš„éƒ½æ˜¯äºŒè¿›åˆ¶çš„å­—èŠ‚ç æ•°æ®ï¼Œåœ¨å‘é€æ•°æ®æ—¶å°±éœ€è¦ç¼–ç ï¼Œæ¥æ”¶æ•°æ®æ—¶å°±éœ€è¦è§£ç </li><li>Netty ä¸ºäº†è§£å†³ Java æœ¬èº«åºåˆ—åŒ–æ€§èƒ½è¾ƒä½çš„ç¼ºç‚¹ï¼Œå¼•å…¥äº† Google Protocol Buffers è¿›è¡Œä¼˜åŒ–ï¼Œä½¿å¾—æ•°æ®ä¼ è¾“æ•ˆç‡æé«˜</li></ul><p><strong>POM åŠ å…¥ä¾èµ–ï¼š</strong></p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.google.protobuf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>protobuf-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.6.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ç¼–å†™ proto æ–‡ä»¶ï¼š</strong></p><div class="language-protobuf line-numbers-mode" data-ext="protobuf"><pre class="language-protobuf"><code><span class="token comment">// ç‰ˆæœ¬</span>
<span class="token keyword">syntax</span> <span class="token operator">=</span> <span class="token string">&quot;proto3&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// ç”Ÿæˆçš„å¤–éƒ¨ç±»åï¼Œä¹Ÿæ˜¯æ–‡ä»¶å</span>
<span class="token keyword">option</span> java_outer_classname <span class="token operator">=</span> <span class="token string">&quot;StudentPOJO&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// proto ä½¿ç”¨ message ç®¡ç†æ•°æ®ï¼Œä¸‹é¢çš„å†™æ³•ä¼šåœ¨ StudentPOJO å¤–éƒ¨ç±»ä¸­ç”Ÿæˆä¸€ä¸ªå†…éƒ¨ç±» Studentï¼Œè¿™æ˜¯çœŸæ­£çš„ POJO å¯¹è±¡</span>
<span class="token keyword">message</span> <span class="token class-name">Student</span> <span class="token punctuation">{</span>
  <span class="token comment">// ä¸‹é¢ä¸æ˜¯èµ‹å€¼è¯­å¥ï¼Œè€Œæ˜¯æŒ‡æ˜ id çš„åºå·ä¸º 1</span>
  <span class="token builtin">int32</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token builtin">string</span> name <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä¸‹è½½ protoc.exeï¼Œä½¿ç”¨å‘½ä»¤ protoc.exe --java_out=. Student.proto ç”Ÿæˆå¯¹åº”çš„ç±»</strong></p><p><strong>æœåŠ¡ç«¯æŒ‡å®šè§£ç å™¨åŠå…¶ç±»å‹ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
    <span class="token comment">// ä½¿ç”¨ NioServerSocketChannel ä½œä¸ºæœåŠ¡å™¨çš„é€šé“å®ç°</span>
    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token comment">// ä¿æŒè¿æ¥çŠ¶æ€</span>
    <span class="token punctuation">.</span><span class="token function">childOption</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_KEEPALIVE</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token comment">// è®¾ç½® workerGroup çš„ EventGroup å¯¹åº”çš„ç®¡é“çš„å¤„ç†å™¨</span>
    <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç»™ Pipeline è®¾ç½®å¤„ç†å™¨</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> socketChannel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æŒ‡å®šå¯¹å“ªç§å¯¹è±¡è¿›è¡Œè§£ç </span>
            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;decoder&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ProtobufDecoder</span><span class="token punctuation">(</span><span class="token class-name">StudentPOJO<span class="token punctuation">.</span>Student</span><span class="token punctuation">.</span><span class="token function">getDefaultInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NettyServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æœåŠ¡ç«¯å¤„ç†å™¨å–å‡ºç›¸åº”å¯¹è±¡ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// è¯»å–å®¢æˆ·ç«¯å‘é€çš„å¯¹è±¡</span>
        <span class="token class-name">StudentPOJO<span class="token punctuation">.</span>Student</span> student <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StudentPOJO<span class="token punctuation">.</span>Student</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å®¢æˆ·ç«¯å‘é€çš„æ•°æ® id: &quot;</span> <span class="token operator">+</span> student<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; name: &quot;</span> <span class="token operator">+</span> student<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å®¢æˆ·ç«¯æŒ‡å®šç¼–ç å™¨ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>eventExecutors<span class="token punctuation">)</span>
    <span class="token comment">// è®¾ç½®å®¢æˆ·ç«¯é€šé“çš„å®ç°</span>
    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token comment">// è®¾ç½®å¤„ç†å™¨</span>
    <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> socketChannel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// åŠ å…¥ç¼–ç å™¨</span>
            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;encoder&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ProtobufEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NettyClientHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å®¢æˆ·ç«¯å¤„ç†å™¨å‘é€å¯¹è±¡ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyClientHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// å‘é€ä¸€ä¸ª Student å¯¹è±¡åˆ°æœåŠ¡å™¨</span>
        <span class="token class-name">StudentPOJO<span class="token punctuation">.</span>Student</span> student <span class="token operator">=</span> <span class="token class-name">StudentPOJO<span class="token punctuation">.</span>Student</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;å¼ ä¸‰&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>student<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="å…¥æ ˆå‡ºæ ˆæœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#å…¥æ ˆå‡ºæ ˆæœºåˆ¶" aria-hidden="true">#</a> å…¥æ ˆå‡ºæ ˆæœºåˆ¶</h2><ul><li>ChannelPipeline æä¾› ChannelHandler çš„å®¹å™¨é“¾</li><li>å¦‚æœäº‹ä»¶è¿åŠ¨æ–¹å‘æ˜¯ä» ChannelPipeline åˆ° SocketChannelï¼Œå‘ç”Ÿå†™æ“ä½œï¼Œéœ€è¦ç¼–ç ï¼Œç§°ä¹‹ä¸ºå‡ºæ ˆï¼Œå³ ChannelPipeline å‘é€ç»™ SocketChannel çš„æ•°æ®ä¼šé€šè¿‡ Pipeline ä¸­çš„ä¸€ç³»åˆ— ChannelOutBoundHandler å¹¶è¢«å¤„ç†ï¼›ä¸ä¹‹ç›¸åçš„å°±ç§°ä¹‹ä¸ºå…¥æ ˆï¼Œå‘ç”Ÿè¯»æ“ä½œï¼Œéœ€è¦è§£ç ï¼Œä¼šè¢«ä¸€ç³»åˆ— ChannelInBoundHandler å¤„ç†</li><li>å‡ºæ ˆæˆ–è€…å…¥æ ˆæ—¶ï¼Œéœ€è¦ç¼–ç æˆ–è€…è§£ç ï¼Œç”±äºä¸çŸ¥é“è¿œç¨‹èŠ‚ç‚¹æ˜¯å¦ä¼šä¸€æ¬¡ æ€§å‘é€ä¸€ä¸ªå®Œæ•´çš„ä¿¡æ¯ï¼Œæœ‰å¯èƒ½ä¼šå‡ºç°ã€Œç²˜åŒ…æ‹†åŒ…ã€çš„é—®é¢˜ï¼ŒNetty ä¸­æœ‰ç›¸åº”çš„ç±»ï¼ˆByteToMessageDecoderï¼‰å¯¹å…¥æ ˆæ•°æ®è¿›è¡Œç¼“å†²ï¼Œç›´åˆ°è¿™ä¸ªæ•°æ®å‡†å¤‡å¥½è¢«å¤„ç†</li><li>åœ¨ç¼–è§£ç çš„æ—¶å€™ï¼Œå¦‚æœæ”¶åˆ°çš„æ¶ˆæ¯ç±»å‹ä¸æŒ‡å®šçš„ç±»å‹ä¸€è‡´æ‰ä¼šè¿›è¡Œç¼–ç æˆ–è€…è§£ç çš„æ“ä½œï¼Œå¦åˆ™å°±ç›´æ¥è·³è¿‡</li><li>å…¶ä»–å¸¸ç”¨çš„ï¼ˆç¼–ï¼‰è§£ç å™¨ï¼š <ul><li><code>ReplayingDecoder</code>ï¼šæ‰©å±•äº† <code>ByteToMessageDecoder</code>ï¼ˆä½†æ˜¯é€Ÿåº¦å¯èƒ½ä¼šç¨å¾®æ…¢ç‚¹ï¼‰ï¼Œä½¿ç”¨è¯¥ç±»æ—¶ä¸éœ€è¦è°ƒç”¨ <code>readableByte()</code> æ–¹æ³•ï¼Œè€Œæ˜¯ä½¿ç”¨æ³›å‹çš„å½¢å¼æŒ‡å®šç”¨æˆ·çŠ¶æ€ç®¡ç†çš„ç±»å‹</li><li><code>LineBasedFrameDecoder</code>ï¼šä½¿ç”¨è¡Œå°¾æ§åˆ¶ç¬¦ï¼ˆ\n æˆ–è€… \r\nï¼‰ä½œä¸ºåˆ†éš”ç¬¦æ¥è§£ææ•°æ®</li><li><code>DelimiterBasedFrameDecoder</code>ï¼šå¯ä»¥è‡ªå®šä¹‰ç‰¹æ®Šå­—ç¬¦ä½œä¸ºæ¶ˆæ¯çš„åˆ†éš”å­—ç¬¦</li><li><code>HttpObjectDecoder</code>ï¼šè§£æ HTTP æ•°æ®</li><li><code>LengthFieldBasedFrameDecoder</code>ï¼šé€šè¿‡æŒ‡å®šé•¿åº¦æ¥æ ‡è¯†æ•´åŒ…æ¶ˆæ¯ï¼Œè¿™æ ·å°±å¯ä»¥è‡ªåŠ¨å¤„ç†é»åŒ…å’ŒåŠåŒ…çš„æ¶ˆæ¯</li></ul></li></ul><p>[è¡¥å……] ç²˜åŒ…æ‹†åŒ…ï¼šTCP æ˜¯é¢å‘è¿æ¥é¢å‘æµçš„ï¼Œæ”¶å‘ä¸¤ç«¯éƒ½éœ€è¦æœ‰æˆå¯¹çš„ Socketã€‚å‘é€ç«¯ä¸ºäº†é«˜æ•ˆåœ°å°†å¤šä¸ªåŒ…å‘é€ç»™æ¥æ”¶ç«¯ï¼Œä¼šè¿›è¡Œä¼˜åŒ–ï¼Œå°†å¤šæ¬¡é—´éš”è¾ƒå°ä¸”æ•°æ®é‡å°çš„æ•°æ®ï¼Œåˆå¹¶æˆä¸€ä¸ªå¤§çš„æ•°æ®å—ï¼Œç„¶åè¿›è¡Œå°åŒ…ï¼ˆç²˜åŒ…ï¼‰ï¼Œè¿™æ ·è™½ç„¶èƒ½æé«˜æ•ˆç‡ï¼Œä½†æ˜¯é¢å‘æµçš„é€šè®¯æ—¶æ²¡æœ‰æ¶ˆæ¯ä¿æŠ¤è¾¹ç•Œçš„ï¼Œæ‰€ä»¥æ¥æ”¶ç«¯å°±éœ€è¦åšå‡ºé¢å¤–çš„å¤„ç†</p><p><strong>ç¼–ç å™¨ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ByteToLongEncoder</span> <span class="token keyword">extends</span> <span class="token class-name">MessageToByteEncoder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Long</span> msg<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å¼€å§‹è¿›è¡Œç¼–ç  msg: &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">writeLong</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>è§£ç å™¨ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ByteToLongDecoder</span> <span class="token keyword">extends</span> <span class="token class-name">ByteToMessageDecoder</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> in<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å¼€å§‹è¿›è¡Œè§£ç ...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å¦‚æœæ²¡æœ‰å¤§äºç­‰äºæœŸæœ›è·å–çš„ç±»å‹çš„å­—èŠ‚æ•°ï¼ˆè¿™é‡ŒæœŸæœ›çš„ç±»å‹æ˜¯ Longï¼Œå­—èŠ‚æ•°æ˜¯ 8ï¼‰ï¼Œé‚£ä¹ˆå°±ä¸åº”è¯¥æ”¾å…¥ out Listï¼Œå› ä¸ºæ­¤æ—¶è·å–çš„æ•°æ®ä¸æ˜¯æœŸæœ›çš„ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸ªåˆ¤æ–­ï¼Œæ¥æ”¶åˆ°çš„æ•°æ®å¯èƒ½å°±å’Œé¢„æœŸçš„æœ‰å·®åˆ«</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            out<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">readLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æœåŠ¡ç«¯ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Server</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">EventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EventLoopGroup</span> workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerBootstrap</span> serverBootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            serverBootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ChannelFuture</span> channelFuture <span class="token operator">=</span> serverBootstrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token number">7000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            channelFuture<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            bossGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            workerGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å®¢æˆ·ç«¯ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">EventLoopGroup</span> group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Bootstrap</span> bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClientInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ChannelFuture</span> channelFuture <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">7000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            channelFuture<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            group<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æœåŠ¡ç«¯åˆå§‹åŒ–ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServerInitializer</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> socketChannel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å…¥æ ˆ Handler è§£ç </span>
        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteToLongDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å‡ºæ ˆ Handler ç¼–ç </span>
        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteToLongEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åŠ å…¥ä¸šåŠ¡å¤„ç†å™¨</span>
        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å®¢æˆ·ç«¯åˆå§‹åŒ–ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClientInitializer</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> socketChannel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> socketChannel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ä¸‹é¢çš„ç¼–è§£ç å™¨çš„é¡ºåºå¯ä»¥è°ƒæ¢ï¼Œä¸å½±å“ï¼Œå› ä¸ºä¼šè‡ªåŠ¨åˆ¤æ–­æ˜¯å…¥ç«™è¿˜æ˜¯å‡ºæˆ˜</span>
        <span class="token comment">// å…¥æ ˆ Handler è§£ç </span>
        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteToLongDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å‡ºæ ˆ Handler ç¼–ç </span>
        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteToLongEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è‡ªå®šä¹‰ Handler å¤„ç†ä¸šåŠ¡</span>
        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClientHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æœåŠ¡ç«¯å¤„ç†å™¨ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">SimpleChannelInboundHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Long</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å®¢æˆ·ç«¯: &quot;</span> <span class="token operator">+</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; å‘é€çš„æ•°æ®: &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ç»™å®¢æˆ·ç«¯ä¼šé€æ¶ˆæ¯</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡ç«¯å‘é€æ¶ˆæ¯...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token number">784327L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å®¢æˆ·ç«¯å¤„ç†å™¨ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClientHandler</span> <span class="token keyword">extends</span> <span class="token class-name">SimpleChannelInboundHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Long</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æ”¶åˆ°æœåŠ¡å™¨çš„æ¶ˆæ¯: &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å®¢æˆ·ç«¯å‘é€æ•°æ®...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token number">123456L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><footer class="page-meta"><!----><div class="meta-item git-info"><div class="update-time"><span class="label">Last update: </span><!----></div><div class="contributors"><span class="label">Contributors: </span><!--[--><!--[--><span class="contributor" title="email: 1627121193@qq.com">æ ¼å…¹æ²ƒ</span><!--]--><!--]--></div></div></footer><nav class="page-nav"><a href="/article/netty/" class="nav-link active prev" aria-label="Netty"><div class="hint"><span class="arrow start"></span>Prev</div><div class="link"><FontIcon></FontIcon>Netty</div></a><!----></nav><div class="giscus-wrapper input-top" id="comment" style="display:block;"><div style="text-align:center">Loading...</div></div><!----><!--]--></main><div data-v-717f1b97></div></div><!--]--><!----></div><!--]--><!--]--><!----><div id="pwa-install"><!----><div id="install-modal-wrapper" style="display:none;"><div class="background"></div><div class="install-modal"><div class="header"><button class="close-button" aria-label="Close"><svg xmlns="http://www.w3.org/2000/svg" class="icon close-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="close icon"><path d="M589.654 511.965 1007.212 84.22a49.777 49.777 0 0 0-.73-70.02 49.046 49.046 0 0 0-69.687.665L519.967 441.946 85.882 14.2a49.08 49.08 0 0 0-69.687.664 49.777 49.777 0 0 0 .664 70.019l433.454 427.082L16.859 939.048a49.777 49.777 0 0 0-.664 70.019 49.013 49.013 0 0 0 69.687.663l434.085-427.746 416.828 427.083A49.013 49.013 0 0 0 972.037 1024a48.416 48.416 0 0 0 34.512-14.27 49.777 49.777 0 0 0 .73-70.019z"></path></svg></button><div class="logo"><!----><div class="title"><h1></h1><p class="desc">This app can be installed on your PC or mobile device.  This will allow this web app to look and behave like any other installed app.  You will find it in your app lists and be able to pin it to your home screen, start menus or task bars.  This installed web app will also be able to safely interact with other apps and your operating system. </p></div></div></div><div class="content"><div class="highlight"><!----><!----></div><div class="description"><h3>Description</h3><p></p></div></div><div class="button-wrapper"><button class="install-button">Install<span></span></button><button class="cancel-button">Cancel</button></div></div></div></div><!----><!--]--></div>
    <script type="module" src="/assets/app-f746a503.js" defer></script>
  </body>
</html>
