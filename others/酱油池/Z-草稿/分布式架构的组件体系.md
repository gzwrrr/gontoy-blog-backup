# 概览

- 注册/发现（必须）
- 调用/负载均衡
- 配置中心
- 路由网关
- 熔断限流/降级
- 链路追踪



<br/>

# 注册中心

- 注册中心记录了服务和服务地址的映射关系
- 注册中心给客户端提供可调用的服务列表，客户端就可以进行远程调用
- 注册中心是整个服务调用的核心，是分布式系统中必要的组件
- 注册中心分为两大类：
  - 临时实例：发送心跳告诉注册中心服务存活
  - 永久实例：通过 API 填写客户端信息，注册中心会主动检测客户端是否在线（不在线也不会去掉）

**常见的注册中心：**

| 序号 |   名称    |             说明              |
| :--: | :-------: | :---------------------------: |
|  1   |  Eureka   |     Netflix 已经停止维护      |
|  2   | Zookeeper |               /               |
|  3   |  CoreDNS  |               /               |
|  4   |  Consul   | Go 语言编写的，与 Eureka 相似 |
|  5   |   Nacos   |        Alibaba 旗下的         |

**注册中心功能对比：**

|     功能     |                            eureka                            |                            consul                            |                           nacos                           |
| :----------: | :----------------------------------------------------------: | :----------------------------------------------------------: | :-------------------------------------------------------: |
| 配置中心功能 |                            不支持                            | 支持，但是用起来偏麻烦，不太符合 Spring Boot 框架的命名风格，支持动态刷新 | 支持，用起来简单，符合SpringBoot 的命名风格，支持动态刷新 |
|     依赖     |                        依赖 Zookeeper                        |                        不依赖其他组件                        |                      不依赖其他组件                       |
|  应用内/外   |     直接集成到应用中，依赖于应用自身完成服务的注册与发现     |                    属于外部应用，侵入性小                    |                  属于外部应用，侵入性小                   |
|   ACP 原则   | 遵循 AP 原则，有较强的可用性，服务注册块，单牺牲了一定的一致性 | 遵循 CP 原则服务注册稍慢，由于其一致性导致了在 leader 挂掉重新选举期间整个 Consul 不可用 |                通知遵循 CP 原则和 AP 原则                 |
|   版本迭代   |                      目前已经不进行升级                      |                     目前仍然进行版本迭代                     |                   目前仍然进行版本迭代                    |
|   集成支持   |                   只支持 SpringCloud 集成                    |                  支持 SpringCloud、K8S 集成                  |             支持 Dubbo、SpringCloud、K8S 集成             |
|   访问协议   |                             HTPP                             |                           HTTP/DNS                           |                     HTTP/动态DNS/UDP                      |
|   雪崩保护   |                             支持                             |                            不支持                            |                           支持                            |
|     界面     |                           英文界面                           |                   英文界面，不符合国人习惯                   |                         中文界面                          |
|     上手     |                             容易                             |                           复杂一点                           |              极易，中文文档，案例，社区活跃               |



<br/>

# 服务调用与负载均衡

**服务调用：**

- 各个微服务之间需要通过网络进行远程调用其他服务的接口

- RESTful 风格的网络请求是常见的交互方式

**常用的服务调用工具：**

- Dubbo
- Feign/OpenFeign
- HttpClient
- RestTemplate

**负载均衡：**

- 将接口分摊到多个服务上减轻单个服务的压力
- 负载均衡的具体算法实现有多种
- 负载均衡分为客户端（如：Ribbon）和服务端（如：Nginx、F5）两种

注：OpenFeign 和较新版的 Spring Cloud Eureka 默认集成了 Ribbon

<br/>

# 配置中心

**管理各个环境的配置文件参数，如：**

- 数据库
- 缓存
- 存储
- 业务应用

**配置中心的作用：**

- 本地配置在服务启动时加载，此后修改配置可以不用重启服务
- 不适用配置中心时多个环境（prod、dev、sit、uat）的配置可能混乱
- 使用配置中心时，如果出现配置错误可以比较容易的回滚到指定版本

**常见的配置中心：**

- Spring Cloud Config
- Apollo
- Nacos

**配置中心功能对比：**

|    功能    | Spring Cloud Config |   Apollo   |   Nacos    |
| :--------: | :-----------------: | :--------: | :--------: |
|   实效性   |   SpringCloudBus    | HTTP长轮询 | HTTP长轮询 |
|  权限控制  |        支持         |    支持    |    支持    |
|  灰度发布  |        支持         |    支持    |   不支持   |
|  版本管理  |        支持         |    支持    |    支持    |
|  版本回滚  |        支持         |    支持    |    支持    |
| 多环境支持 |        支持         |    支持    |    支持    |



<br/>

# 路由网关

**API 网关在微服务架构中提供（列举部分）：**

- 路由转发
- 认证鉴权
- 限流

**网关的作用：**

- 让客户端统一访问接口
- 隐藏服务的内部接口
- 可以添加一个额外的保护层防止恶意攻击
- 可以对所有请求进行权限校验
- 可以记录访问日志并审计

**常用的网关：**

- KONG（通过lua-nginx-module实现的在nginx中运行的lua应用程序）
- Zuul
- Spring Cloud Gateway（用于替代 Zuul）



<br/>

# 熔断限流

当前系统资源不够的情况下，不足以应对大量的用户请i去，为了保证剩余的资源能够提供服务，系统应该按照对流量或者功能做出一定限制

**熔断限流的作用：**

- 增加容错率：发生错误请求或者超时时，阻止其调用接口，直接调用本地的 fallback
- 当并发度超过服务能承受的极限时熔断报错

- 不使用熔断时，如果服务端发生错误，客户端会接收到错误状态的 Response，此时程序处理不当可能会抛异常，严重可能导致其他服务不可用
- 可以一定程度避免浪费其他系统资源

**常用的熔断限流组件：**

- Hystrix（Spring Cloud）
- Sentinel（Alibaba 哨兵）



<br/>

# 链路追踪

调用链：分布式系统中用于追踪用户的请求过程，包括：

- 数据采集
- 数据传输
- 数据存储
- 数据分析
- 数据可视化展示

**链路追踪的作用：**

- 调用链可以用于微服务代码的调式和服务监控，可以帮助改善性能和缺陷
- 分布式系统中一次请求可能经过多个模块、中间件、服务器实例，这些请求还有可能是并发的，使用链路追踪就可以确定这些过程的先后顺序
- 主要是可以在日益复杂的业务系统中快速地定位问题所在

**常用链路追踪组件：**

- SkyWalking：追踪、监控、诊断分布式系统
- Zipkin：通过一系列拦截器采集数据监控系统性能
- Pinpoint：无入侵的轻量 APM 监控工具