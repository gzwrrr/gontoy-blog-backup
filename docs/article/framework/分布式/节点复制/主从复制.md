---
title: "主从复制"
shortTitle: "主从复制"
description: "主从复制"
icon: ""
author: 
  name: gzw
  url: 
  email: 1627121193@qq.com
isOriginal: false
date: 2022-11-25
category: 
- "分布式"
- "小知识点"
tag:
- "分布式"
- "小知识点"
sticky: 1
star: false
article: true
timeline: true,
dir:
  text: "主从复制"
  icon: ""
  collapsible: true
  index: true
  comment: true
headerDepth: 3
index: true
order: 2
copy:
  triggerWords: 100
  disableCopy: false
  disableSelection: false
feed:
  title: "主从复制"
  description: "主从复制"
  author:
    name: gzw
    email: 1627121193@qq.com
---


# 主从复制

—— 需要在 **可用性** 与 **一致性** 之间的做出权衡





## 简述

- 赋予副本不同角色，其中存在一个主副本
- 主副本将数据存储子啊本地后，将数据更改作为 **日志** 或者以 **更改流** 的方式发送到各个副本（结点）
- 写请求全部打到主副本上，读请求主从副本均可处理（做到了负载均衡，但是存在 **一致性** 问题）



<br/>

## 复制方式

分为 **异步复制** 和 **同步复制**

- 异步复制：主副本保存完成后立即向客户端返回成功消息（此时不同副本的 **读请求** 可能出现数据不一致）
- 同步复制：主副本等待数据传送到从副本，并且得到确认之后向客户端返回成功消息



<br/>

## 一致性问题

两种角度：

- 客户端只从主副本读取数据（如 Kafaka）
- 采用同步复制（单纯的同步复制会有问题，如一个副本故障会阻塞），这样会非常影响吞吐量；如果只使用异步复制并由主副本承担读请求，当主副本发生故障切换结点时也会发生数据不一致的问题



<br/>

## 抛出问题

让用户决策是使用同步还是异步，使用不同语义决定：

- 客户端使用 acks 参数确认
- ISR 机制



<br/>

## 主从复制需要的能力

- 新增（从）副本（Kafuka 中新增副本会 **追赶** 主副本的数据，数据库中使用 **快照** + **增量**）
  - 过程：某时间点产生一个一致性的快照，将快照拷贝到从节点，从节点连接到主节点并请求所有快照点后发生的日志改变
  - 追赶：获取到日志后，应用到自己的副本中（上述过程可能发生多次）
- 处理结点失效
  - 主节点失效：使用 **节点切换**，三个步骤：确认主节点失效（例如无心跳响应）、选举新的主节点（新节点与旧节点差距要小）、重配系统使新节点生效
  - 从节点失效：使用 **追赶式恢复 **（从节点获取崩溃前执行的最后一个事务，使用上述的 **追赶** 恢复）

注：主节点失效情况下，如果是使用 **异步复制** 还可能导致数据不一致的问题，可能是主节点在角色转变后还没意识到从而对数据造成破坏；此外主节点超时时间设置也是个问题：太长会导致服务不可用，太短可能导致节点频繁切换



<br/>

## 复制滞后

- 同步复制可能会影响到吞吐量和可用性，但是使用异步复制又可能会造成数据不一致，此处需要做出权衡
- **最终一致性**：客户端读取不同的副本的数据可能不一致，即复制滞后的现象，存在这种问题的复制行为所形成的数据一致性统称为最终一致性

