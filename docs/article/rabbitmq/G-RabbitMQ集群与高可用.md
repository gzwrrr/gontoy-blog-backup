---
title: "RabbitMQ 集群和高可用"
shortTitle: "G-RabbitMQ 集群和高可用"
description: "RabbitMQ 集群和高可用"
icon: ""
author: 
  name: gzw
  url: 
  email: 1627121193@qq.com
isOriginal: false
date: 2022-05-09
category: 
- "通信"
- "中间件"
- "rabbitmq"
tag:
- "通信"
- "中间件"
- "rabbitmq"
sticky: 1
star: false
article: true
timeline: true,
dir:
  text: "RabbitMQ 集群和高可用"
  icon: ""
  collapsible: true
  index: true
  comment: true
headerDepth: 3
index: true
order: 2
copy:
  triggerWords: 100
  disableCopy: false
  disableSelection: false
feed:
  title: "RabbitMQ 集群和高可用"
  description: "RabbitMQ 集群和高可用"
  author:
    name: gzw
    email: 1627121193@qq.com
---



# RabbitMQ 集群和高可用

:::info RabbitMQ 集群

RabbitMQ 集群是一组运行了 RabbitMQ 节点的机器，它们在逻辑上组成一个单一的逻辑 Broker。集群中的每个节点都有相同的队列、交换器、绑定和用户，它们使用 Erlang 分布式机制通信。RabbitMQ 集群的好处是可以通过添加节点来增加负载能力和高可用性。

:::



[[toc]]



## 前言

### 何如实现高可用？

:::info 说明

RabbitMQ 是基于主从（非分布式）做高可用性的，有三种模式：

1. 单机模式
2. 普通集群模式
3. 镜像集群模式

:::



普通集群模式：

1. 意思就是在多台机器上启动多个 RabbitMQ 实例，每台机器启动一个

2. 创建的 queue，只会放在一个 RabbitMQ 实例上，但是每个实例都同步 queue 的元数据（元数据可以认为是 queue 的一些配置信息，通过元数据，可以找到 queue 所在实例）
3. 消费的时候，实际上如果连接到了另外一个实例，那么那个实例会从 queue 所在实例上拉取数据过来
4. 要么消费者每次随机连接一个实例然后拉取数据，要么固定连接那个 queue 所在实例消费数据，前者有数据拉取的开销，后者导致单实例性能瓶颈
5. 如果存放数据的 queue 的实例宕机了，会导致接下来其他实例就无法从那个实例拉取，如果开启了消息持久化，让 RabbitMQ 落地存储消息的话，消息不一定会丢，得等这个实例恢复了，然后才可以继续从这个 queue 拉取数据
6. 该方案实际上没有保证高可用性，主要是提高了「吞吐量」



镜像集群模式：

1. RabbitMQ 高可用性是通过镜像队列（Mirrored Queue）来实现的
2. 镜像队列是指队列的所有数据都会被复制到其他节点上，从而实现数据的备份和冗余
3. 当主节点出现故障时，备份节点可以接管并继续提供服务，从而实现高可用性





### 实现一般步骤

RabbitMQ 集群和高可用性的实现可以通过以下步骤来完成：

1. 安装 RabbitMQ。可以在多个节点上安装 RabbitMQ，然后在其中一个节点上启动 RabbitMQ，其他节点将自动加入集群。
2. 配置节点。每个节点都需要配置主机名、IP 地址、Erlang Cookie 等信息。这些配置将用于节点之间的通信和识别。
3. 启动 RabbitMQ 节点。在所有节点上启动 RabbitMQ。
4. 设置镜像队列。创建镜像队列时需要指定队列的名称、持久性和其他参数。队列将自动复制到其他节点上。
5. 测试镜像队列。可以发送和接收消息以测试镜像队列是否正常工作。
6. 配置负载均衡。可以使用负载均衡器将流量分配到多个节点上，从而增加负载能力和高可用性。



### 优缺点

RabbitMQ 集群和高可用性的优点包括：

1. 集群可以通过添加节点来增加负载能力和高可用性。
2. 镜像队列可以确保数据的冗余和备份，从而提高可靠性。
3. 负载均衡可以平衡流量，并将请求分配到多个节点上，从而提高性能和可用性。
4. RabbitMQ 的集群和高可用性功能都是开源的，可以免费使用和定制。

RabbitMQ 集群和高可用性的缺点包括：

1. 集群和镜像队列需要消耗更多的资源和带宽。
2. 集群配置和维护比单个节点更复杂。
3. RabbitMQ 集群和高可用性只提供了一定程度的可靠性，无法保证 100% 的可用性。







## 镜像队列

:::info 镜像队列

RabbitMQ中的镜像队列是为了提高队列的可用性而设计的。当一个队列被声明为镜像队列时，队列会在多个节点（即镜像节点）之间进行复制，从而保证即使某个节点宕机，也能够保证队列的数据不会丢失。

:::

![RabbitMQ 镜像队列](https://my-photos-1.oss-cn-hangzhou.aliyuncs.com/markdown//rabbitmq/20230310/%E9%95%9C%E5%83%8F%E9%98%9F%E5%88%97.png)

1. 每个镜像队列有一个主节点和多个镜像节点，每个节点都有一个或多个队列副本。
2. 生产者将消息发送到主节点，主节点将消息复制到所有的镜像节点上的队列副本中。
3. 消费者可以从任意一个镜像节点上的队列副本中消费消息。
4. 当主节点宕机时，集群会自动从剩余的镜像节点中选择一个新的主节点。
5. 当镜像节点宕机时，它上面的队列副本会自动被删除，集群会自动将其从镜像队列的备选节点列表中删除，避免消费者从已经失效的节点上读取消息。
6. 每个镜像队列的所有节点都应该使用相同的配置，如队列名称、路由键、队列属性等。

**注意点：**

1. 使用镜像队列还需要考虑队列的新增节点、节点失效、选举机制、故障恢复、消息同步等
2. 镜像队列不可以作为负载均衡使用，因为所有操作在每个节点上都会重复一遍



### GM 模块

:::info GM

RabbitMQ 的 GM 模块指的是 "Gossip-based Membership"（基于 Gossip 协议的成员管理），它是 RabbitMQ 中集群成员管理的核心组件之一。在 RabbitMQ 集群中，每个节点都需要知道当前集群中的所有节点信息，包括节点的名称、IP 地址、状态等。这些信息的维护和更新需要一个高效、可靠的成员管理系统。

:::

**大致流程：**

GM模块实现的一种可靠的组播通讯协议，该协议能够保证组播消息的原子性，即保证组中活着的节点要么都收到消息要么都收不到。它的实现大致如下：

将所有的节点形成一个循环链表，每个节点都会监控位于自己左右两边的节点，当有节点新增时，相邻的节点保证当前广播的消息会复制到新的节点上；当有节点失效时，相邻的节点会接管保证本次广播的消息会复制到所有的节点。在master节点和slave节点上的这些gm形成一个group，group（gm_group）的信息会记录在mnesia中。不同的镜像队列形成不同的group。消息从master节点对于的gm发出后，顺着链表依次传送到所有的节点，由于所有节点组成一个循环链表，master节点对应的gm最终会收到自己发送的消息，这个时候master节点就知道消息已经复制到所有的slave节点了。

**补充：**

1. GM 模块使用了 Gossip 协议来管理集群的成员。Gossip 协议是一种去中心化的成员管理协议，其核心思想是：每个节点定期随机选择另一个节点并与其进行信息交换，从而逐渐将集群中的所有节点信息传递给所有节点。每个节点通过自己所接收到的其他节点的信息来更新自己的视图，保证视图的一致性。
2. 在 RabbitMQ 集群中，每个节点都运行一个 GM 模块，GM 模块负责维护节点信息和群集状态。当一个节点启动时，它会通过 GM 模块向集群中的其他节点发送一个 "Hello" 消息，表示自己的加入。其他节点接收到 "Hello" 消息后，将自己的节点信息发送给新加入的节点，并将新节点加入到自己的成员列表中。新节点接收到其他节点的信息后，也会将其加入到自己的成员列表中。这样，新节点就完成了对群集的加入。
3. 在集群中，如果有节点失效，其他节点会定期发送 "Ping" 消息来检测失效节点。如果在一定时间内没有收到失效节点的响应，则认为该节点已经失效，并将其从成员列表中移除。同时，如果节点发现自己与其他节点的连接出现问题，也会将对应的节点从成员列表中移除。
4. GM 模块的使用可以保证 RabbitMQ 集群的可靠性和高可用性，可以有效地解决因节点故障或网络问题导致的集群不可用问题。





## 注意点

### 新增节点

如果需要新增节点，可以通过 RabbitMQ 的 Cluster Federation 插件来实现。首先需要在新增节点上安装 Cluster Federation 插件，然后在 RabbitMQ 集群中创建一个 upstream 集群，并将其与新增节点关联。这样一来，当消息发布到 upstream 集群中的某个节点时，会自动将其同步到新增的节点上。



### 节点失效

当节点失效时，RabbitMQ 镜像队列的机制会自动将该节点上的消息同步到其他节点上，以保证消息不会丢失。同时，如果该节点上的队列已经被声明为镜像队列，那么镜像队列中的副本也会自动被选为主节点，以保证消息能够正常消费。



### 选举机制

RabbitMQ 镜像队列的选举机制是通过心跳机制来实现的。当一个节点发现另一个节点失效时，会通过心跳机制来判断该节点是否真的失效。如果该节点确实已经失效，那么就会将该节点上的消息同步到其他节点上，并选举一个新的节点作为主节点。



### 故障恢复

如果某个节点在一段时间内无法恢复正常工作，那么 RabbitMQ 镜像队列会自动将该节点上的消息同步到其他节点上。当该节点重新启动后，会自动从其他节点上同步最新的消息，以恢复正常工作。



### 消息同步

RabbitMQ 镜像队列的消息同步机制是通过 AMQP 协议来实现的。当消息发布到一个节点上时，会自动将该消息同步到其他节点上，以保证消息不会丢失。当消费者订阅一个队列时，会自动从主节点上获取该队列中的消息，而其他节点上的消息仅作为副本备份。



### AMQP 与 Gossip

1. AMQP（Advanced Message Queuing Protocol）是一种网络协议，用于在分布式系统中 **传输消息**。RabbitMQ是AMQP的一个实现。

2. 而Gossip协议是一个用于在分布式系统中 **传播状态更新** 的协议。GM模块使用的就是Gossip协议来实现 **消息同步机制**。

因此，AMQP和Gossip是两种不同的协议，它们之间没有包含关系。在RabbitMQ中，AMQP协议主要用于客户端和Broker之间的通信，而GM模块使用的Gossip协议则主要用于在Broker之间同步消息状态。







## 补充

:::info 相关文章（转）

[RabbitMQ之镜像队列 – CSDN 朱小厮 原创](https://blog.csdn.net/u013256816/article/details/71097186)

[搭建高可用/高可靠的RabbitMQ镜像队列集群架构 – 腾讯云开发者社区 端碗吹水](https://cloud.tencent.com/developer/article/1754922)

:::

