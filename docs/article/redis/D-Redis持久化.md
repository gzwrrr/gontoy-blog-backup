---
title: "Redis 持久化"
shortTitle: "D-Redis 持久化"
description: "Redis 持久化"
icon: ""
author: 
  name: gzw
  url: 
  email: 1627121193@qq.com
isOriginal: false
date: 2022-02-22
category: 
- "redis"
- "数据库"
- "缓存"
tag:
- "redis"
- "数据库"
- "缓存"
sticky: 1
star: false
article: true
timeline: true
dir:
  text: "Redis 持久化"
  icon: ""
  collapsible: true
  index: true
  comment: true
headerDepth: 3
index: true
order: 2
copy:
  triggerWords: 100
  disableCopy: false
  disableSelection: false
feed:
  title: "Redis 持久化"
  description: "Redis 持久化"
  author:
    name: gzw
    email: 1627121193@qq.com
---





# Redis 持久化

[[toc]]

:::warning

主服务器不进行 **持久化** 时进行复制时是非常危险的，因为没有持久化时 Redis 重启会造成主服务器数据清空，如果使用了哨兵模式且主服务器重启过快没有检测出错误，那么从服务器的数据也会一并清空

:::

- rdb 保存的文件是 dump.rdb，aof 保存的文件是 appendonly.aof 文件
- redis 会在指定的时间间隔内将内存中的数据集快照写入磁盘，它恢复时时将快照文件直接读到内存中
- redis 会单独创建（fork）一个子进程来进行持久化，先将数据写到一个临时文件中，待持久化过程都结束了，再用这个临时文件替换上持久化好的文件
- 上述过程中，主进程不进行任何 IO 操作，这确保了极高的性能。
- 如果需要进行大规模数据的恢复，且对于数据恢复的完整性不是非常敏感，那么 rdb 的方式要比 aof 的方式更加高效，但是 rdb 有可能会将最后一次持久化后的数据丢失



## 1.RDB

RDB：Redis DataBase，在指定的时间间隔内将内存中的数据集快照写入磁盘，实际操作过程是fork一个子进程，先将数据集写入临时文件，写入成功后，再替换之前的文件，用二进制压缩存储

**1.rdb 文件保存的触发规则：**

- 配置文件中 save 的规则满足的情况下会触发
- 执行 flushall 命令会触发 
- 退出 redis 时会触发
- 备份会触发

**2.恢复 rdb 文件：**

- 只需要将 rdb 文件放在 redis 的启动目录即可

**3.优点：**

- 整个Redis数据库将只包含一个文件 dump.rdb，方便持久化，容灾性好，方便备份
- 相对于数据集大时，比 AOF 的启动效率更高，适合大规模的数据恢复，对数据的完整性要求不高
- 性能最大化，fork 子进程来完成写操作，让主进程继续处理命令，所以是 IO 最大化。使用单独子进程来进行持久化，主进程不会进行任何 IO 操作，保证了 redis 的高性能

**4.缺点：**

- 需要一定时间进行进程操作，如果中途出意外，那么最后一次修改的数据可能丢失
- 数据安全性低。RDB 是间隔一段时间进行持久化，如果持久化之间 redis 发生故障，会发生数据丢失。所以这种方式更适合数据要求不严谨的时候
- fork 进行的时候会占用一定的空间
- 由于RDB是通过fork子进程来协助完成数据持久化工作的，因此，如果当数据集较大时，可能会导致整个服务器停止服务几百毫秒，甚至是1秒钟







## 2.AOF

AOF：Append Only File，以日志的形式记录服务器所处理的每一个写、删除操作，查询操作不会记录，以文本的方式记录，可以打开文件看到详细的操作记录

- 将所有命令都记录下来，恢复时会把这个文件的命令全部执行一遍
- 以日志的形式记录每个写操作，将 redis 执行过的所有命令都记录下来（读操作不记录）
- 只能追加文件，不能改写文件
- 默认不开启，开启将 appendonly 改为 yes 即可

**1.优点：**

- 数据安全，Redis中提供了3中同步策略，即每秒同步、每修改同步和不同步。事实上，每秒同步也是异步完成的，其效率也是非常高的，所差的是一旦系统出现宕机现象，那么这一秒钟之内修改的数据将会丢失。而每修改同步，我们可以将其视为同步持久化，即每次发生的数据变化都会被立即记录到磁盘中
- 每次修改都会同步，文件完整性更好
- 通过 append 模式写文件，即使中途服务器宕机也不会破坏已经存在的内容，可以通过 redis-check-aof 工具解决数据一致性问题
- AOF 机制的 rewrite 模式。定期对AOF文件进行重写，以达到压缩的目的

**2.缺点：**

- 默认每秒同步一次，可能丢失数据
- 不同步效率更高
- 相对于数据文件来说，aof 远远大于 rdb，修复的速度也比 rdb 慢
- aof 的运行效率也比 rdb 低



## 3.小结

- AOF文件比RDB更新频率高，优先使用AOF还原数据。

- AOF比RDB更安全也更大

- RDB性能比AOF好

- 如果两个都配了优先加载AOF