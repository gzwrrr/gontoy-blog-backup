---
title: "ElasticSearch 原理"
shortTitle: "A-ElasticSearch 原理"
description: "ElasticSearch 原理"
icon: ""
author: 
  name: gzw
  url: 
  email: 1627121193@qq.com
isOriginal: false
date: 2022-04-23
category: 
- "中间件"
- "elasticsearch"
tag:
- "中间件"
- "elasticsearch"
sticky: 1
star: false
article: true
timeline: true
dir:
  text: "ElasticSearch 原理"
  icon: ""
  collapsible: true
  index: true
  comment: true
headerDepth: 3
index: true
order: 2
copy:
  triggerWords: 100
  disableCopy: false
  disableSelection: false
feed:
  title: "ElasticSearch 原理"
  description: "ElasticSearch 原理"
  author:
    name: gzw
    email: 1627121193@qq.com
---







# ElasticSearch 原理

[[toc]]



## 前言

Elasticsearch 尽可能地屏蔽了分布式系统的复杂性。这里列举了一些在后台自动执行的操作：

- 分配文档到不同的容器 或 *分片* 中，文档可以储存在一个或多个节点中
- 按集群节点来均衡分配这些分片，从而对索引和搜索过程进行负载均衡
- 复制每个分片以支持数据冗余，从而防止硬件故障导致的数据丢失
- 将集群中任一节点的请求路由到存有相关数据的节点
- 集群扩容时无缝整合新节点，重新分配分片以便从离群节点恢复





## 基础概念

- 索引：数据存储在一个或者多个索引中，类似SQL中的数据库。ES中的索引可能由一个或多个Lucene索引构成（由索引分片、复制机制、配置等决定）
- 文档：由字段构成，每个字段有字段名以及一个或多个字段值。文档没有固定的模式或强制的结构。
- 映射：所有文档在写入索引前都必须进行分析，可以设置一些参数来决定如何分割词条以及哪些被过滤。简单来说映射就是存储元信息
- 类型：每个文档都有与之相对应的类型定义，这样可以在一个文档中存储多种文档类型，并为不同文档类型提供不同的映射。
- 节点：单个ES服务实例称为节点。
- 集群：多个节点协同处理数据，这些节点组成的系统称为集群。
- 分片：集群允许系统存储的数据总量超过单机容量，ES将数据散布到索格物理Lucene索引上，这些Lucene索引就称为分片，散布这些分片的过程就称为分片处理。
- 副本：副本解决了访问压力过大时单机无法处理所有请求的问题。
- 网关：索引设置的各种信息都会被收集起来，并在网关中被持久化。

补充：

- 通常情况下，我们使用的术语 *对象* 和 *文档* 是可以互相替换的。不过，有一个区别： 一个对象仅仅是类似于 hash 、 hashmap 、字典或者关联数组的 JSON 对象，对象中也可以嵌套其他的对象。 对象可能包含了另外一些对象。在 Elasticsearch 中，术语 *文档* 有着特定的含义。它是指最顶层或者根对象, 这个根对象被序列化成 JSON 并存储到 Elasticsearch 中，指定了唯一 ID。
- ES使用对等架构（P2P）避免单点故障，节点会自动连接到集群中的其他节点，进行数据交换和监控操作，其中就包括了索引分片和自动复制。
- ES分布式特性使得查询延迟和节点间数据不同步难以避免，ES使用准实时搜索和版本同步。





## 工作流程

### 启动过程

- 节点启动时使用广播或者单播来发现同一个集群中的其他节点并与他们连接。
- 节点中会有一个节点被选为管理节点（master），该节点负责集群的状态管理以及对集群拓扑结构发生的变化做出反应，分发索引分片到集群相应的节点上。
- 管理节点并不比其他节点重要，因为ES使用的是对等架构，这个架构下不需要知道哪个是管理节点，所有的操作可以发送至任意节点，并合并搜索结果。



### 故障检测

管理节点会监控所有可用节点，如果任意节点在预定的超时时间内没有响应，则认为该节点已经断开，随后启动错误处理过程。

错误处理中需要在集群-分片之间重新做平衡，而新分片和副本的放置策略是可配置的。



### 查询

查询不是一个简单单步骤的操作，一般会分为两个阶段：

- 分散阶段：将query分发到包含相关文档的多个分片中执行查询。
- 合并阶段：从多个分片中收集返回的结果，对他们进行合并、排序、后续处理，随后返回给客户端。



### 特别注意

- 建立索引的操作只会发生在主分片上，当把一个索引请求发送到某节点后，如果该节点没有对应的主分片或者只有副本，那么这个请求会被转发到拥有正确的主分片的节点。





## 集群原理

> 对于大多数的数据库而言，通常需要对应用程序进行非常大的改动，才能利用上横向扩容的新增资源。 与之相反的是，ElastiSearch天生就是 *分布式的* ，它知道如何通过管理多节点来提高扩容性和可用性。 这也意味着你的应用无需关注这个问题。



### 空集群

> 一个运行中的 Elasticsearch 实例称为一个节点，而集群是由一个或者多个拥有相同 `cluster.name` 配置的节点组成， 它们共同承担数据和负载的压力。当有节点加入集群中或者从集群中移除节点时，集群将会重新平均分布所有的数据。

**主节点：**

当一个节点被选举成为 *主* 节点时， 它将负责管理集群范围内的所有变更，例如增加、删除索引，或者增加、删除节点等。 

主节点并不需要涉及到文档级别的变更和搜索等操作，所以当集群只拥有一个主节点的情况下，即使流量的增加它也不会成为瓶颈。 任何节点都可以成为主节点。我们的示例集群就只有一个节点，所以它同时也成为了主节点。

**管理透明：**

作为用户，我们可以将请求发送到 *集群中的任何节点* ，包括主节点。

每个节点都知道任意文档所处的位置，并且能够将我们的请求直接转发到存储我们所需文档的节点。

无论我们将请求发送到哪个节点，它都能负责从各个包含我们所需文档的节点收集回数据，并将最终结果返回給客户端。 

Elasticsearch 对这一切的管理都是透明的。





### 健康监控

> Elasticsearch 的集群监控信息中包含了许多的统计数据，其中最为重要的一项就是 *集群健康* ， 它在 `status` 字段中展示为 `green` 、 `yellow` 或者 `red` 。

`status` 字段指示着当前集群在总体上是否工作正常。它的三种颜色含义如下：

- `green`：所有的主分片和副本分片都正常运行。
- `yellow`：所有的主分片都正常运行，但不是所有的副本分片都正常运行。
- `red`：有主分片没能正常运行。



### 故障转移

可以在同一个目录内，完全依照启动第一个节点的方式来启动一个新节点。多个节点可以共享同一个目录。

当你在同一台机器上启动了第二个节点时，只要它和第一个节点有同样的 `cluster.name` 配置，它就会自动发现集群并加入到其中。 

但是在不同机器上启动节点的时候，为了加入到同一集群，你需要配置一个可连接到的单播主机列表（[最好使用单播代替组播](https://www.elastic.co/guide/cn/elasticsearch/guide/current/important-configuration-changes.html#unicast)）。

当第二个节点加入到集群后，每个主分片对应的副本分片都会被分配到该节点上。 这意味着当集群内任何一个节点出现问题时，我们的数据都完好无损。

所有新近被索引的文档都将会保存在主分片上，然后被并行的复制到对应的副本分片上。这就保证了我们既可以从主分片又可以从副本分片上获得文档。





### 水平扩容

水平扩容后，为了分散负载会对分片进行重新分配

分片是一个功能完整的搜索引擎，它拥有使用一个节点上的所有资源的能力。

拥有6个分片（3个主分片和3个副本分片）的索引可以最大扩容到6个节点，每个节点上存在一个分片，并且每个分片拥有所在节点的全部资源。

读操作——搜索和返回数据——可以同时被主分片 *或* 副本分片所处理，所以拥有越多的副本分片，将拥有越高的吞吐量。

更大的扩容：主分片的数目在索引创建时就已经确定了下来，但是副本分片的数量可以随时进行调整（如果只是在相同节点数目的集群上增加更多的副本分片并不能提高性能，因为每个分片从节点上获得的资源会变少。 需要增加更多的硬件资源来提升吞吐量）。





### 分片

**分片：**

- 一个分片是一个底层的工作单元 ，它仅保存了全部数据中的一部分。
- 一个分片是一个 Lucene 的实例，以及它本身就是一个完整的搜索引擎。
- 一个分片可以是 *主* 分片或者 *副本* 分片。 索引内任意一个文档都归属于一个主分片，所以主分片的数目决定着索引能够保存的最大数据量。一个副本分片只是一个主分片的拷贝。副本分片作为硬件故障时保护数据不丢失的冗余备份，并为搜索和返回文档等读操作提供服务。在索引建立的时候就已经确定了主分片数，但是副本分片数可以随时修改。索引在默认情况下会被分配 5 个主分片。

```json
{
   "settings" : {
      // 3 个主分片
      "number_of_shards" : 3,
      // 每个主分片 1 个副本
      "number_of_replicas" : 1
   }
}
```

**存储：**

- 文档被存储和索引到分片内，但是应用程序是直接与索引而不是与分片进行交互。
- Elasticsearch 是利用分片将数据分发到集群内各处的。
- 分片是数据的容器，文档保存在分片内，分片又被分配到集群内的各个节点里。
- 技术上来说，一个主分片最大能够存储 Integer.MAX_VALUE - 128 个文档，但是实际最大值还需要参考你的使用场景：包括你使用的硬件， 文档的大小和复杂程度，索引和查询文档的方式以及你期望的响应时长。

**扩缩容：**当集群规模扩大或者缩小时， Elasticsearch 会自动的在各节点中迁移分片，使得数据仍然均匀分布在集群里。



分片是将一个索引分割乘若干个更小的索引，从而能在同一集群的不同节点上散布他们。

在查询时，结果是索引中每个分片返回结果的汇总。

ES默认为每个索引创建5个分片（单节点下也是），这种冗余称为「过渡分配」。

ES默认配置为5个分片和1个副本，从而使得数据量增长和多分片搜索结果合并之间达到平衡。

实际生产中，最理想的分片数量应该依赖于节点的数量，经验公式为：$节点数 = 分片数 * (副本数 + 1)$，如果计划使用10个分片和2个副本，那么设置的最大节点数将会是30。

 分片数一般是越少越好，但是过度分配也有好处，因为一个分片是一个Lucene索引，较小的分片索引过程会较快，但是最后合并的代价也会上升。





### 副本

副本的数量可以通过API随时更改。

使用过多副本最明显的缺点就是占用额外的存储空间，其次主分片和副本之间的数据拷贝也存在时间开销。



### 路由

路由可以设置别名。

ES允许在一次查询重使用多个路由值。

文档放置在那个分片上依赖于文档的路由值，而多路由查询意味着在一个或者多个分片上查询。



