---
title: "MySQL 锁"
shortTitle: "D-MySQL 锁"
description: "MySQL 锁"
icon: ""
author: 
  name: gzw
  url: 
  email: 1627121193@qq.com
isOriginal: false
date: 2021-05-29
category: 
- "mysql"
- "数据库"
tag:
- "mysql"
- "数据库"
sticky: 1
star: false
article: true
timeline: true
dir:
  text: "MySQL 锁"
  icon: ""
  collapsible: true
  index: true
  comment: true
headerDepth: 3
index: true
order: 2
copy:
  triggerWords: 100
  disableCopy: false
  disableSelection: false
feed:
  title: "MySQL 锁"
  description: "MySQL 锁"
  author:
    name: gzw
    email: 1627121193@qq.com
---







# MySQL 锁

[[toc]]


## 分类

**按锁粒度分类：**

1. 行锁：锁某行数据，粒度最小，并发度最高
2. 表锁：锁整张表，粒度最大，并发度最低
3. 间隙锁：锁住一个区间

**按读写分类：**

1. 共享锁（S 锁）：读锁，一个事务给某行数据加了读锁，那么其他事务还是能读但是不能写
2. 排他锁（X 锁）：写锁，一个事务给某行数据加了写锁，那么其他事务不能读也不能写

**还可以分为：**

1. 悲观锁：上述的锁都是悲观锁
2. 乐观锁：使用版本号等不会真正锁住某行数据的方式来实现

| 锁名称                                 | 解释                                                         | 隔离级别             | 使用场景                                           |
| -------------------------------------- | ------------------------------------------------------------ | -------------------- | -------------------------------------------------- |
| 共享锁（Shared Lock）                  | 允许读取并发操作，但阻止写操作                               | RR、RC、Serializable | 适用于读取操作较多的情况，如查询                   |
| 排他锁（Exclusive Lock）               | 阻止读取和写操作并发进行                                     | RR、RC、Serializable | 适用于写操作较多的情况，如更新、删除               |
| 意向共享锁（Intention Shared Lock）    | 表示事务将要在某个范围内加共享锁                             | 所有隔离级别         | 由数据库自动加上，一般不需要手动加锁               |
| 意向排他锁（Intention Exclusive Lock） | 表示事务将要在某个范围内加排他锁                             | 所有隔离级别         | 由数据库自动加上，一般不需要手动加锁               |
| 记录锁（Record Lock）                  | 锁定一条记录                                                 | RR、RC、Serializable | 适用于对某些记录进行加锁的场景                     |
| 间隙锁（Gap Lock）                     | 锁定记录之间的间隙，防止其他事务在这个范围内插入记录         | RR、RC、Serializable | 适用于防止其他事务在某个范围内插入记录的场景       |
| 临键锁（Next-Key Lock）                | 既锁定了记录之间的间隙，也锁定了记录本身，防止其他事务在这个范围内插入或修改记录 | RR、RC、Serializable | 适用于防止其他事务在某个范围内插入或修改记录的场景 |
| 行锁（Row Lock）                       | 锁定一行记录                                                 | RR、RC、Serializable | 适用于需要锁定单个记录的场景                       |
| 表锁（Table Lock）                     | 锁定整张表                                                   | 所有隔离级别         | 适用于需要全表操作的场景，如备份、数据导入等       |

==注意：==以上隔离级别指的是使用该锁时可以使用的隔离级别，但并不代表该锁只能在该隔离级别下使用，实际上大多数锁在所有隔离级别下都可以使用。





## 行锁和记录锁

在MySQL中，行锁和记录锁是两种不同的锁类型。它们的区别在于锁定的粒度不同。

1. 行锁：

   行锁是指在执行SQL语句时，对某一行记录进行的锁定。行锁的优点是粒度小，可以避免大面积的锁冲突，提高并发性能。MySQL中的InnoDB引擎支持行锁。

2. 记录锁：

   记录锁是指在执行SQL语句时，对某一个索引记录进行的锁定。记录锁的优点是锁定的范围更小，能够减少锁冲突，提高并发性能。MySQL中的MyISAM引擎支持记录锁。

需要注意的是，MySQL中的行锁和记录锁并不是严格区分的。如果对某一行记录进行锁定，也会同时对其对应的索引记录进行锁定，因为这两者是相关的。同时，在使用InnoDB引擎时，可以通过设置参数来控制行锁和记录锁的使用，以提高并发性能和数据一致性。





## 临键锁和间隙锁

> 临键锁相当于记录锁和间隙锁的组合

“临键”指的是记录之间的空隙（gap），因为临键锁实际上是锁定了记录之间的空隙。在执行一个查询语句时，如果MySQL需要对一个范围内的记录加锁，它会将这个范围分为若干个间隙，然后对这些间隙加锁。例如，对id在1到10之间的记录加锁时，MySQL会将这个范围分为10个间隙（1-2之间的间隙、2-3之间的间隙、3-4之间的间隙……9-10之间的间隙），然后对这些间隙加锁。

和临键锁类似的是间隙锁（Gap Lock），间隙锁也是锁定记录之间的间隙。不同的是，临键锁既锁定了记录之间的间隙，也锁定了记录本身；而间隙锁只锁定了记录之间的间隙，不锁定记录本身。举个例子，假设在一个表中id为1的记录被加了排他锁，这个时候如果有一个查询语句需要锁定id在1到10之间的记录，MySQL会先锁定id为1的记录，然后锁定id为2到10之间的间隙，这样其他事务就无法在这个范围内插入记录。如果使用的是临键锁，MySQL会将id为1到10之间的所有记录都锁定，包括id为1的记录和id为2到10之间的间隙。

由于临键锁和间隙锁都是锁定了记录之间的间隙，它们的作用和特点比较相似，容易混淆。区别在于临键锁除了锁定间隙，还锁定了记录本身，而间隙锁只锁定了间隙。因此，在使用这两种锁的时候，需要根据具体情况进行选择。例如，如果要防止其他事务在一个范围内插入记录，可以使用间隙锁；如果要防止其他事务在一个范围内插入或修改记录，可以使用临键锁。





## 其他

1. innodb对于行的查询使用next-key lock

2. Next-locking keying为了解决Phantom Problem幻读问题

3. 当查询的索引含有唯一属性时，将next-key lock降级为record key

4. Gap锁设计的目的是为了阻止多个事务将记录插入到同一范围内，而这会导致幻读问题的产生

5. 有两种方式显式关闭gap锁：（除了外键约束和唯一性检查外，其余情况仅使用record lock） 
   1. 将事务隔离级别设置为RC
   2. 将参数innodb_locks_unsafe_for_binlog设置为1

