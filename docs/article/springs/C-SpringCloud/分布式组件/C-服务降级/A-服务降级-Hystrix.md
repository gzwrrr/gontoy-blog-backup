---
title: "服务降级-Hystrix"
shortTitle: "A-服务降级-Hystrix"
description: "服务降级-Hystrix"
icon: ""
author: 
  name: gzw
  url: 
  email: 1627121193@qq.com
isOriginal: false
date: 2022-06-01
category: 
- "分布式"
tag:
- "分布式"
sticky: 1
star: false
article: true
timeline: true
dir:
  text: "服务降级-Hystrix"
  icon: ""
  collapsible: true
  index: true
  comment: true
headerDepth: 3
index: true
order: 2
copy:
  triggerWords: 100
  disableCopy: false
  disableSelection: false
feed:
  title: "服务降级-Hystrix"
  description: "服务降级-Hystrix"
  author:
    name: gzw
    email: 1627121193@qq.com
---







# 服务降级-Hystrix

> 需要手动搭建监控平台，没有一套 Web 界面能让我们进行更加细粒度的配置

- 一个用于处理分布式系统的**延迟**和**容错**的开源库
- 保证在一个依赖出问题的情况下，不会导致整体服务失败，避免了级联故障，提高了分布式系统的弹性
- 断路器本身是一种开关装置，当某个服务单元发生故障之后，通过断路器的故障监控（类似熔断保险丝），向调用方返回一个符合预期的、可处理的备选响应（FallBack），而不是长时间的等待或者抛出调用方无法处理的异常
- 保障了服务调用方的线程不会被长时间且不必要地占用，从而避免了故障在分布式系统中的蔓延乃至雪崩





## 服务降级（Fallback）

- 向调用方返回一个符合预期的、可处理的备选响应（FallBack）
- 发生服务降级的情况：
  - 程序运行异常
  - 超时
  - 服务熔断触发服务降级
  - 线程池/信号量打满





## 服务熔断（Break）

- 达到最大访问量后，直接拒绝访问，然后调用服务降级方法返回提示
- 熔断机制是应对**雪崩效应**的一种微服务链路保护机制
- 当扇出链路的某个微服务出错不可用或者响应时间太长就会进行服务降级，进而熔断该节点的微服务的调用，快速返回错误的响应信息
- 当检测到该节点微服务调用响应正常后，恢复调用链路
- 在 Spring Cloud 中，Hystrix 会监控微服务间的调用状况，以此实现熔断机制
- 当失败的调用到达一定的阈值后（默认是 5 秒内 20 次调用失败），就会启动熔断机制
- 熔断状态：
  - 打开：请求不再调用当前服务，内部设置始终一般为 MTTR（平均故障处理时间），当打开时长达到所设时钟则进入半熔断状态
  - 关闭：不会对服务进行熔断
  - 半开：部分请求根据规则调用当前服务，如果请求成功且符合规则则认为当前服务恢复正常，关闭熔断
- 断路器的三个重要参数：
  - 快照时间窗口：断路器确定是否打开需要统计一些请求和错误数据，统计的时间范围就是快照时间窗口，默认为最近的 10 秒
  - 请求总数阈值：在快照时间窗口内，必须满足请求总数阈值才有资格熔断。默认为 20，意味着在 10 秒内，如果该 Hystrix 命令的调用次数不足 20 次，即使所有的请求都超时或者因为其他的原因而失败，断路器也不会打开
  - 错误百分比阈值：当请求总数在快照时间窗口内超过了阈值，比如发生了 30 次调用，如果在这 30 次调用中，有 15 次发生了超时异常，也就是超过了 50% 的错误百分比，那么在默认设定的 50% 阈值的情况下，断路器就会打开
- Hystrix 的自动恢复功能：
  - 当断路器打开时，会对主逻辑进行熔断，之后会启动一个休眠时间窗口，在这个时间窗口内，降级逻辑临时成为逻辑
  - 当休眠窗口期到期，断路器会进入半开状态，释放一次请求到原来的主逻辑上，如果此次请求正常返回，那么断路器将关闭，主逻辑恢复
  - 如果这次请求依然有问题，那么还是保持打开的状态，休眠时间窗口重新计时





## 服务限流（Flowlimit）

- 在类似秒杀的高并发场景下，严禁流量瞬间涌入，此时请求需要排队有序进入