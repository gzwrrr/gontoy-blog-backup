---
title: "接口调用出错的应对策略"
shortTitle: "接口调用出错的应对策略"
description: "接口调用出错的应对策略"
icon: ""
author: 
  name: gzw
  url: 
  email: 1627121193@qq.com
isOriginal: false
date: 2022-06-21
category: 
- "通用"
- "编程"
tag:
- "通用"
- "编程"
sticky: 1
star: false
article: true
timeline: true,
dir:
  text: "接口调用出错的应对策略"
  icon: ""
  collapsible: true
  index: true
  comment: true
headerDepth: 3
index: true
order: 2
copy:
  triggerWords: 100
  disableCopy: false
  disableSelection: false
feed:
  title: "接口调用出错的应对策略"
  description: "接口调用出错的应对策略"
  author:
    name: gzw
    email: 1627121193@qq.com
---



# 接口调用出错的应对策略

[[toc]]


# 写在前面

- 对于接口调用失败的情况，如果没有相应的容错应对策略很可能导致服务不可用
- 常见的容错策略有：
  - 故障转移
  - 快速失败
  - 安全失败
  - 沉默失败



<br/>

# 故障转移

- 高可用的服务集群中（尤其是被依赖的关键服务）均会部署多个副本
- 这些节点可以部署在不同的节点、网络交换区、可用区（分别应对节点宕机、网络分区、不可抗力导致的故障）
- 故障转移是指如果调用的服务器出现故障，系统不会立即向调用者返回失败结果，而是自动切换到其他的节点尝试返回成功调用的结果
- 这样可以保证整体的高可用性



<br/>

# 快速失败

- 有一些业务场景是不允许做故障转移的，因为故障转移策略的前提是服务具备幂等性
- 对于非幂等性的服务，重复调用就可能产生脏数据，这样带来的麻烦远远大于某次服务调用失败的，此时应该选择快速失败作为容错策略
- 当非幂等性服务调用失败后，往往是不清楚哪一步出现异常的，此时为了避免重复操作，最恰当的做法就是尽快让服务报错，尽快抛出异常让调用者处理



<br/>

# 安全失败

- 在一个调用链路中的服务通常分为主路和旁路，即不是每个服务都是不可或缺的，有些服务失败了也不影响核心业务的正确性
- 使用 Spring 开发时，通过扩展点、事件或者 AOP 注入的逻辑通常都属于旁路逻辑，如：审计、日志、调式信息等
- 属于旁路逻辑的另一个显著特征是后续处理不会依赖其返回值，或者该返回值不会影响后续的处理结果
- 对于这类旁路逻辑，一种理想的容错策略是：即使旁路逻辑失败了也当作正确的返回；如果需要返回值的话，系统就自动返回一个符合返回类型的值
- 失败后系统会自动记录一条服务调用出错的日志备查，这样的策略就被称为安全失败



<br/>

# 沉默失败

- 如果大量请求需要等到才是或者长时间处理后才能宣告失败，那么很容易由于某个远程服务的请求堆积而消耗大量的线程、内存、网络等资源而影响系统稳定
- 对于这种情况，一种合理的策略是当请求在一段时间连续失败若干次后，默认服务提供方在以一定时间内无法再对外服务，此时进行熔断，不在向它分配请求流量，即将错误隔离开来，避免对其他部分产生影响，这样的策略就被称为沉默失败



<br/>

# 优缺点/应用场景

| 容错策略 |                        优点                        |                          缺点                          |                 应用场景                 |
| :------: | :------------------------------------------------: | :----------------------------------------------------: | :--------------------------------------: |
| 故障转移 |     系统自动处理<br />调用者对失败的信息不可见     |          增加了调用时间<br />消耗了额外的资源          | 调用的是幂等性服务<br />对调用时间不敏感 |
| 快速失败 | 调用者对失败的处理有控制权<br />不依赖服务的幂等性 | 调用则必须正确处理失败<br />如果只是抛异常可能引起雪崩 |  调用的是非幂等性服务<br />超时阈值较低  |
| 安全失败 |                   不影响主路逻辑                   |                    只适用于旁路调用                    |            调用链中的旁路服务            |
| 沉默失败 |             能够控制错误，避免影响整体             |             出错的服务将在一段时间内不可用             |              频繁超时的服务              |

